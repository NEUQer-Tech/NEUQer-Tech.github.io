<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>数据库中间件--ShardingJDBC(附小demo) - 不洗碗工作室公共博客</title><meta name="Description" content=""><meta property="og:title" content="数据库中间件--ShardingJDBC(附小demo)" />
<meta property="og:description" content="一、ShardingJDBC概述 官网：http://shardingsphere.apache.org/index_zh.html 1.概述 Apache" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6-shardingjdbc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-27T23:02:09+08:00" />
<meta property="article:modified_time" content="2022-03-27T23:02:09+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="数据库中间件--ShardingJDBC(附小demo)"/>
<meta name="twitter:description" content="一、ShardingJDBC概述 官网：http://shardingsphere.apache.org/index_zh.html 1.概述 Apache"/>
<meta name="application-name" content="不洗碗工作室公共博客">
<meta name="apple-mobile-web-app-title" content="不洗碗工作室公共博客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/posts/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6-shardingjdbc/" /><link rel="prev" href="http://example.org/posts/fetchapi%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%9F%BA%E7%A1%80/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "数据库中间件--ShardingJDBC(附小demo)",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/posts\/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6-shardingjdbc\/"
        },"genre": "posts","keywords": "技术分享, 数据库中间件","wordcount":  16719 ,
        "url": "http:\/\/example.org\/posts\/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6-shardingjdbc\/","datePublished": "2022-03-27T23:02:09+08:00","dateModified": "2022-03-27T23:02:09+08:00","publisher": {
            "@type": "Organization",
            "name": "周子胜"},"author": {
                "@type": "Person",
                "name": "周子胜"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="不洗碗工作室公共博客">不洗碗工作室公共博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="不洗碗工作室公共博客">不洗碗工作室公共博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">数据库中间件--ShardingJDBC(附小demo)</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/zzs52" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>周子胜</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/"><i class="far fa-folder fa-fw"></i>数据库中间件</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-03-27">2022-03-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 16719 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 34 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#一shardingjdbc概述">一、ShardingJDBC概述</a></li>
        <li><a href="#二shardingjdbc准备---linuxcentos7安装mysql57">二、ShardingJDBC准备 - Linux(centos7)安装MySQL5.7</a></li>
        <li><a href="#三shardingjdbc准备---mysql完成主从复制">三、ShardingJDBC准备 - MySql完成主从复制</a></li>
        <li><a href="#四shardingjdbc的配置和读写分离实践">四、ShardingJDBC的配置和读写分离实践</a></li>
        <li><a href="#五mysql分库分表原理">五、MySQL分库分表原理</a></li>
        <li><a href="#六shardingjdbc的分库和分表实践">六、ShardingJDBC的分库和分表实践</a></li>
        <li><a href="#七分布式主键配置">七、分布式主键配置</a></li>
        <li><a href="#八分库分表---按年月来分案例">八、分库分表 - 按年月来分案例</a></li>
        <li><a href="#九shardingjdbc的事务管理">九、ShardingJDBC的事务管理</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h3 id="一shardingjdbc概述">一、ShardingJDBC概述</h3>
<p>官网：<a href="http://shardingsphere.apache.org/index_zh.html" target="_blank" rel="noopener noreffer">http://shardingsphere.apache.org/index_zh.html</a></p>
<h4 id="1概述">1.概述</h4>
<p>Apache ShardingSphere 是一套开源的分布式数据库解决方案组成的生态圈，它由 JDBC、Proxy 和 Sidecar这 3 款既能够独立部署，又支持混合部署配合使用的产品组成。 它们均提供标准化的数据水平扩展、分布式事务和分布式治理等功能，可适用于如 Java 同构、异构语言、云原生等各种多样化的应用场景。</p>
<p>Apache ShardingSphere 5.x 版本开始致力于可插拔架构，项目的功能组件能够灵活地以可插拔的方式进行扩展。 目前，数据分片、读写分离、数据加密、影子库压测等功能，以及 MySQL、Oracle、PostgreSQL、SQLServer 等 SQL 与协议的支持，均通过插件的方式织入项目。 开发者能够像使用积木一样定制属于自己的独特系统。</p>
<p>ShardingSphere 已于2020年4月16日成为 Apache 软件基金会的顶级项目。</p>
<h4 id="2认识shardingjdbc">2.认识ShardingJDBC</h4>
<p>定位为轻量级 Java 框架，在 Java 的 JDBC 层提供的额外服务。 它使用客户端直连数据库，以 jar 包形式提供服务，无需额外部署和依赖，可理解为增强版的 JDBC 驱动，完全兼容基于 JDBC 的各种 ORM 框架，如：JPA，Mybatis，Hibernate，Spring JDBC Template 或直接使用 JDBC。</p>
<p>支持任何第三方的数据库连接池，如：DBCP,C3P0,Druid,HikariCP,BoneCP等。支持任意实现 JDBC 规范的数据库，目前支持 MySQL，Oracle，SQLServer，PostgreSQL 以及任何遵循 SQL92 标准的数据库。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5cfab03b882c0bcf69b83418b621213b70.png"
        data-srcset="E:%5cNoDishwashingStudio%5cfab03b882c0bcf69b83418b621213b70.png, E:%5cNoDishwashingStudio%5cfab03b882c0bcf69b83418b621213b70.png 1.5x, E:%5cNoDishwashingStudio%5cfab03b882c0bcf69b83418b621213b70.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\fab03b882c0bcf69b83418b621213b70.png"
        title="E:\NoDishwashingStudio\fab03b882c0bcf69b83418b621213b70.png" /></p>
<h4 id="3shardingjdbc功能架构图">3.ShardingJDBC功能架构图</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c18d3a43a4304b380da2dbd100f2eb7de.png"
        data-srcset="E:%5cNoDishwashingStudio%5c18d3a43a4304b380da2dbd100f2eb7de.png, E:%5cNoDishwashingStudio%5c18d3a43a4304b380da2dbd100f2eb7de.png 1.5x, E:%5cNoDishwashingStudio%5c18d3a43a4304b380da2dbd100f2eb7de.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\18d3a43a4304b380da2dbd100f2eb7de.png"
        title="E:\NoDishwashingStudio\18d3a43a4304b380da2dbd100f2eb7de.png" /></p>
<h4 id="4shardingjdbc混合架构">4.ShardingJDBC混合架构</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c8f40f91304567728fe19148a976cb4e6.png"
        data-srcset="E:%5cNoDishwashingStudio%5c8f40f91304567728fe19148a976cb4e6.png, E:%5cNoDishwashingStudio%5c8f40f91304567728fe19148a976cb4e6.png 1.5x, E:%5cNoDishwashingStudio%5c8f40f91304567728fe19148a976cb4e6.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\8f40f91304567728fe19148a976cb4e6.png"
        title="E:\NoDishwashingStudio\8f40f91304567728fe19148a976cb4e6.png" /></p>
<p>ShardingJDBC采用无中心化架构，适用于 Java 开发的高性能的轻量级OLTP（连接事务处理） 应用；ShardingProxy提供静态入口以及异构语言的支持，适用于OLAP（连接数据分析） 应用以及对分片数据库进行管理和运维的场景。</p>
<p>Apache ShardingSphere是多接入端共同组成的生态圈。通过混合使用 ShardingJDBC 和 ShardingProxy，并采用同一注册中心统一配置分片策略，能够灵活的搭建适用于各种场景的应用系统，使得架构师更加自由地调整适合于当前业务的最佳系统架构。</p>
<h4 id="5shardingsphere的功能清单">5.ShardingSphere的功能清单</h4>
<ul>
<li>功能列表
<ul>
<li>数据分片</li>
<li>分库 &amp; 分表</li>
<li>读写分离</li>
<li>分片策略定制化</li>
<li>无中心化分布式主键</li>
</ul>
</li>
<li>分布式事务
<ul>
<li>标准化事务接口</li>
<li>XA强一致事务</li>
<li>柔性事务</li>
<li>数据库治理</li>
</ul>
</li>
<li>分布式治理
<ul>
<li>弹性伸缩</li>
<li>可视化链路追踪</li>
<li>数据加密</li>
</ul>
</li>
</ul>
<h4 id="6shardingsphere数据分片内核剖析">6.ShardingSphere数据分片内核剖析</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5ceeb4c4ddc2aa41e0e03360b3ddb5d239.png"
        data-srcset="E:%5cNoDishwashingStudio%5ceeb4c4ddc2aa41e0e03360b3ddb5d239.png, E:%5cNoDishwashingStudio%5ceeb4c4ddc2aa41e0e03360b3ddb5d239.png 1.5x, E:%5cNoDishwashingStudio%5ceeb4c4ddc2aa41e0e03360b3ddb5d239.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\eeb4c4ddc2aa41e0e03360b3ddb5d239.png"
        title="E:\NoDishwashingStudio\eeb4c4ddc2aa41e0e03360b3ddb5d239.png" /></p>
<blockquote>
<p>SQL 解析</p>
</blockquote>
<p>分为词法解析和语法解析。先通过词法解析器将 SQL 拆分为一个个不可再分的单词。再使用语法解析器对 SQL 进行理解，并最终解析出上下文。 解析上下文包括表、选择项、排序项、分组项、聚合函数、分页信息、查询条件以及可能需要修改的占位符的标记。</p>
<blockquote>
<p>查询优化</p>
</blockquote>
<p>合并和优化分片条件，如 OR 等。</p>
<blockquote>
<p>SQL路由</p>
</blockquote>
<p>根据解析上下文匹配用户配置的分片策略，并生成路由路径。目前支持分片路由和广播路由。</p>
<blockquote>
<p>SQL改写</p>
</blockquote>
<p>将 SQL 改写为在真实数据库中可以正确执行的语句。SQL 改写分为正确性改写和优化改写。</p>
<blockquote>
<p>SQL执行</p>
</blockquote>
<p>通过多线程执行器异步执行。</p>
<blockquote>
<p>结果归并</p>
</blockquote>
<p>将多个执行结果集归并以便于通过统一的 JDBC 接口输出。结果归并包括流式归并、内存归并和使用装饰者模式的追加归并这几种方式。</p>
<h3 id="二shardingjdbc准备---linuxcentos7安装mysql57">二、ShardingJDBC准备 - Linux(centos7)安装MySQL5.7</h3>
<p>在安装之前最好先更新一下源</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">yum update
</code></pre></div><p>可以选择在此路径下安装</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /user/local/mysql
</code></pre></div><p>下载 安装用的MySQL官方的Yum Repository</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">wget -i -c http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm
</code></pre></div><p>然后就可以直接安装了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">yum -y install mysql57-community-release-el7-10.noarch.rpm
</code></pre></div><p>如果是新安装的MySQL，那么在开始安装MySQL服务器之前需要更新其GPG</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
</code></pre></div><p>开始安装MySQL服务器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">yum -y install mysql-community-server
</code></pre></div><p>安装成功后便可以进行MySQL数据库的设置</p>
<p>首先启动MySQL服务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">systemctl start mysqld.service
</code></pre></div><p>查看MySQL运行状态</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">systemctl status mysqld.service
</code></pre></div><p>运行状态如图即可：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c1e4aee34274d1c479f99f1473b4f2c5e.png"
        data-srcset="E:%5cNoDishwashingStudio%5c1e4aee34274d1c479f99f1473b4f2c5e.png, E:%5cNoDishwashingStudio%5c1e4aee34274d1c479f99f1473b4f2c5e.png 1.5x, E:%5cNoDishwashingStudio%5c1e4aee34274d1c479f99f1473b4f2c5e.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\1e4aee34274d1c479f99f1473b4f2c5e.png"
        title="E:\NoDishwashingStudio\1e4aee34274d1c479f99f1473b4f2c5e.png" /></p>
<p>使用MySQL初始密码登录数据库</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">grep <span class="s2">&#34;password&#34;</span> /var/log/mysqld.log

mysql -uroot -p<span class="o">(</span>初始密码<span class="o">)</span>

或者使用一步到位的命令

mysql -uroot -p<span class="k">$(</span>awk <span class="s1">&#39;/temporary password/{print $NF}&#39;</span> /var/log/mysqld.log<span class="k">)</span>
</code></pre></div><p>修改数据库密码</p>
<p>数据库默认密码规则必须携带大小写字母、特殊符号，字符长度大于8否则会报错。
因此设定较为简单的密码时需要首先修改set global validate_password_policy和_length参数值。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">set</span> global <span class="nv">validate_password_policy</span><span class="o">=</span>0<span class="p">;</span>

<span class="nb">set</span> global <span class="nv">validate_password_length</span><span class="o">=</span>1<span class="p">;</span>
</code></pre></div><p>修改密码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">set</span> password <span class="k">for</span> root@localhost <span class="o">=</span> password<span class="o">(</span><span class="s1">&#39;新密码&#39;</span><span class="o">)</span><span class="p">;</span>

或者

ALTER USER <span class="s1">&#39;root&#39;</span>@<span class="s1">&#39;localhost&#39;</span> IDENTIFIED BY <span class="s1">&#39;新密码&#39;</span><span class="p">;</span>
</code></pre></div><p>退出后再登录进行测试</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">mysql -uroot -p<span class="o">(</span>新密码<span class="o">)</span>

show databases<span class="p">;</span>
</code></pre></div><p>用可视化的客户端进行连接</p>
<p>先对数据库进行授权</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">GRANT ALL PRIVILEGES ON *.* TO <span class="s1">&#39;root&#39;</span>@<span class="s1">&#39;%&#39;</span> IDENTIFIED BY <span class="s1">&#39;123456&#39;</span> WITH GRANT OPTION<span class="p">;</span>

FLUSH PRIVILEGES<span class="p">;</span>
</code></pre></div><p>启用FirewallD防火墙，开放3306端口，再重启</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">systemctl start firewalld.service

firewall-cmd --zone<span class="o">=</span>public --add-port<span class="o">=</span>3306/tcp --permanent

systemctl restart firewalld.service
</code></pre></div><p>到此就全部OK了(记得把云服务器安全组3306端口打开)</p>
<h3 id="三shardingjdbc准备---mysql完成主从复制">三、ShardingJDBC准备 - MySql完成主从复制</h3>
<h4 id="1概述-1">1.概述</h4>
<p>主从复制将一个MySQL数据库（主服务器）的数据复制到一个或多个MySQL数据库（从服务器）。</p>
<p>复制是异步的，从站不需要永久连接以接收来自主站的更新。</p>
<p>根据配置，可以复制主服务器中的所有数据库，所选的数据库，所选的表。</p>
<h4 id="2主从复制的好处">2.主从复制的好处</h4>
<ul>
<li>横向扩展：在多个从站之间分配负载以提高性能。在此环境中，所有写入和更新都必须在主服务器上进行。但是，读取可以在一个或多个从服务器上进行。该架构可以提高写入性能（因为主服务器专注于更新），同时显著提高了从服务器的读取速度。</li>
<li>数据安全性：因为数据被复制到从站，并且从站可以暂停复制过程，所以可以在从站上运行备份服务而不会破坏相应的主数据。</li>
<li>分析：可以在主服务器上创建实时数据，而信息分析可以在从服务器上进行，而不会影响主服务器的性能。</li>
</ul>
<h4 id="3replication的原理">3.Replication的原理</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c50716df6ae118b97f18827b333c4ccda.png"
        data-srcset="E:%5cNoDishwashingStudio%5c50716df6ae118b97f18827b333c4ccda.png, E:%5cNoDishwashingStudio%5c50716df6ae118b97f18827b333c4ccda.png 1.5x, E:%5cNoDishwashingStudio%5c50716df6ae118b97f18827b333c4ccda.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\50716df6ae118b97f18827b333c4ccda.png"
        title="E:\NoDishwashingStudio\50716df6ae118b97f18827b333c4ccda.png" /></p>
<p>主服务器上面的任何修改都会通过自己的 I/O tread(I/O 线程)保存在二进制日志 Binary log 里面。</p>
<p>从服务器上面也启动一个 I/O thread，通过配置好的用户名和密码, 连接到主服务器上请求读取二进制日志，然后把读取到的二进制日志写到本地的一个Relay log（中继日志）里面。</p>
<p>从服务器上面同时开启一个 SQL thread 定时检查 Relay log(这个文件也是二进制的)，如果发现有更新立即把更新的内容在本机的数据库上面执行一遍。</p>
<p>从服务器设备负责决定应该执行二进制日志中的哪些语句。除非另行指定，否则主二进制日志中的所有事件都在从站上执行。如果需要，您可以将从服务器配置为仅处理一些特定数据库或表的事件。</p>
<h4 id="4具体配置主从节点">4.具体配置主从节点</h4>
<p>master节点配置(master节点执行)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">vim /etc/my.cnf
</code></pre></div><p>在该文件里添加如下内容</p>
<pre tabindex="0"><code class="language-cnf" data-lang="cnf">[mysqld]
## 同一局域网内注意要唯一
server-id=100  
## 开启二进制日志功能，可以随便取（关键）
log-bin=mysql-bin
## 复制过滤：不需要备份的数据库，不输出（mysql库一般不同步）
binlog-ignore-db=mysql
## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存
binlog_cache_size=1M
## 主从复制的格式（mixed,statement,row，默认格式是statement）
binlog_format=mixed
</code></pre><p>修改完该文件后要重启mysql服务</p>
<p>slave节点配置(slave节点执行)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">vim /etc/my.cnf
</code></pre></div><p>在该文件里添加如下内容</p>
<pre tabindex="0"><code class="language-cnf" data-lang="cnf">[mysqld]
## 设置server_id,注意要唯一
server-id=102
## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用
log-bin=mysql-slave-bin
## relay_log配置中继日志
relay_log=edu-mysql-relay-bin
##复制过滤：不需要备份的数据库，不输出（mysql库一般不同步）
binlog-ignore-db=mysql
## 如果需要同步函数或者存储过程
log_bin_trust_function_creators=true
## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存
binlog_cache_size=1M
## 主从复制的格式（mixed,statement,row，默认格式是statement）
binlog_format=mixed
## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
slave_skip_errors=1062
</code></pre><p>修改完该文件后要重启mysql服务</p>
<p>在master服务器授权slave服务器可以同步的权限(master节点执行)</p>
<p>进入mysql后执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">mysql&gt; grant replication slave, replication client on *.* to <span class="s1">&#39;root&#39;</span>@<span class="s1">&#39;slave服务的ip&#39;</span> identified by <span class="s1">&#39;slave服务器的密码&#39;</span><span class="p">;</span>

mysql&gt; flush privileges<span class="p">;</span>

<span class="c1"># 查看MySQL现在有哪些用户及对应的IP权限</span>
mysql&gt; <span class="k">select</span> user,host from mysql.user<span class="p">;</span>
</code></pre></div><p>查询master服务器的binlog文件名和位置(master节点执行)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">mysql&gt; show master status<span class="p">;</span>
</code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c94a6664c9053f2f16702a1e9d83c8da9.png"
        data-srcset="E:%5cNoDishwashingStudio%5c94a6664c9053f2f16702a1e9d83c8da9.png, E:%5cNoDishwashingStudio%5c94a6664c9053f2f16702a1e9d83c8da9.png 1.5x, E:%5cNoDishwashingStudio%5c94a6664c9053f2f16702a1e9d83c8da9.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\94a6664c9053f2f16702a1e9d83c8da9.png"
        title="E:\NoDishwashingStudio\94a6664c9053f2f16702a1e9d83c8da9.png" /></p>
<p>日志文件名：mysql-bin.000002</p>
<p>复制的位置：2079</p>
<p>slave关联master节点(slave节点执行)</p>
<p>进入到slave节点</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">mysql -uroot -p你slave密码
</code></pre></div><p>开始绑定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">mysql&gt; change master to <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;master服务器ip&#39;</span>, <span class="nv">master_user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span>, <span class="nv">master_password</span><span class="o">=</span><span class="s1">&#39;master密码&#39;</span>, <span class="nv">master_port</span><span class="o">=</span>3306, <span class="nv">master_log_file</span><span class="o">=</span><span class="s1">&#39;mysql-bin.000002&#39;</span>,master_log_pos<span class="o">=</span>2079<span class="p">;</span>
</code></pre></div><p>启动主从复制(slave节点执行)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">mysql&gt; start slave<span class="p">;</span>
</code></pre></div><p>再查看主从同步状态(slave节点执行)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">mysql&gt; show slave status<span class="se">\G</span><span class="p">;</span>
</code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c5b2419b1d7977056090b2a4da7aeba4c.png"
        data-srcset="E:%5cNoDishwashingStudio%5c5b2419b1d7977056090b2a4da7aeba4c.png, E:%5cNoDishwashingStudio%5c5b2419b1d7977056090b2a4da7aeba4c.png 1.5x, E:%5cNoDishwashingStudio%5c5b2419b1d7977056090b2a4da7aeba4c.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\5b2419b1d7977056090b2a4da7aeba4c.png"
        title="E:\NoDishwashingStudio\5b2419b1d7977056090b2a4da7aeba4c.png" /></p>
<h3 id="四shardingjdbc的配置和读写分离实践">四、ShardingJDBC的配置和读写分离实践</h3>
<h4 id="1内容大纲">1.内容大纲</h4>
<ul>
<li>新建一个springboot工程</li>
<li>修改application.properties为application.yml并配置application.yml</li>
<li>引入shardingJDBC相关的依赖、数据库驱动依赖等</li>
<li>定义entity、mapper、controller等</li>
<li>访问测试查看效果</li>
</ul>
<h4 id="2具体实现步骤">2.具体实现步骤</h4>
<blockquote>
<p>新建一个springboot工程</p>
</blockquote>
<blockquote>
<p>修改application.properties为application.yml并配置application.yml</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8085</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">main</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">allow-bean-definition-overriding</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">shardingsphere</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># 参数配置，显示sql</span><span class="w">
</span><span class="w">    </span><span class="nt">props</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">sql</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">show</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c"># 配置数据源</span><span class="w">
</span><span class="w">    </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 给每个数据源取别名，下面的ds0,ds1任意取名字</span><span class="w">
</span><span class="w">      </span><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="l">ds0,ds1</span><span class="w">
</span><span class="w">      </span><span class="c"># 给master-ds0数据源配置数据库连接信息</span><span class="w">
</span><span class="w">      </span><span class="nt">ds0</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># 配置druid数据源</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource</span><span class="w">
</span><span class="w">        </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://121.40.184.179:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><span class="w">
</span><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span>*<span class="w">
</span><span class="w">        </span><span class="nt">maxPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">        </span><span class="nt">minPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置ds1-slave</span><span class="w">
</span><span class="w">      </span><span class="nt">ds1</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource</span><span class="w">
</span><span class="w">        </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://121.40.100.114:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><span class="w">
</span><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span>*<span class="w">
</span><span class="w">        </span><span class="nt">maxPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">        </span><span class="nt">minPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">    </span><span class="c"># 配置默认数据源ds0</span><span class="w">
</span><span class="w">    </span><span class="nt">sharding</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 默认数据源，主要用于写，注意一定要配置读写分离,注意：如果不配置，那么就会把这两个节点都当做从slave节点，新增，修改和删除会出错。</span><span class="w">
</span><span class="w">      </span><span class="nt">default-data-source-name</span><span class="p">:</span><span class="w"> </span><span class="l">ds0</span><span class="w">
</span><span class="w"></span><span class="c">#     配置数据源的读写分离，但是数据库一定要做主从复制</span><span class="w">
</span><span class="w"></span><span class="c">#    masterslave:</span><span class="w">
</span><span class="w"></span><span class="c">#      # 配置主从名称，可以任意取名字</span><span class="w">
</span><span class="w"></span><span class="c">#      name: ms</span><span class="w">
</span><span class="w"></span><span class="c">#      # 配置主库master，负责数据的写入</span><span class="w">
</span><span class="w"></span><span class="c">#      master-data-source-name: ds0</span><span class="w">
</span><span class="w"></span><span class="c">#      # 配置从库slave节点</span><span class="w">
</span><span class="w"></span><span class="c">#      slave-data-source-names: ds1</span><span class="w">
</span><span class="w"></span><span class="c">#      # 配置slave节点的负载均衡均衡策略，采用轮询机制(如果采用随机分配机制就用random_robin)</span><span class="w">
</span><span class="w"></span><span class="c">#      load-balance-algorithm-type: round_robin</span><span class="w">
</span><span class="w"></span><span class="c"># 整合mybatis的配置XXXXX</span><span class="w">
</span><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">mapper-locations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:mapper/*.xml</span><span class="w">
</span><span class="w">  </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com.zzs.shardingJdbc.entity</span><span class="w">
</span></code></pre></div><blockquote>
<p>引入相关依赖</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">&lt;properties&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;java.version&gt;1.8&lt;/java.version&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;sharding-sphere.version&gt;4.0.0-RC1&lt;/sharding-sphere.version&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/properties&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;!-- 依赖web --&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;dependency&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;!-- 依赖mybatis和mysql驱动 --&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;dependency&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;version&gt;2.1.4&lt;/version&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;dependency&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;groupId&gt;mysql&lt;/groupId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;scope&gt;runtime&lt;/scope&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;!--依赖lombok--&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;dependency&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;optional&gt;true&lt;/optional&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;dependency&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;scope&gt;test&lt;/scope&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;!--依赖sharding--&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;dependency&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;artifactId&gt;sharding-jdbc-spring-boot-starter&lt;/artifactId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;version&gt;${sharding-sphere.version}&lt;/version&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;dependency&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;artifactId&gt;sharding-core-common&lt;/artifactId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;version&gt;${sharding-sphere.version}&lt;/version&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;!--依赖数据源druid--&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;dependency&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;</span><span class="w">
</span><span class="w">    </span><span class="l">&lt;version&gt;1.1.21&lt;/version&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/dependency&gt;</span><span class="w">
</span></code></pre></div><blockquote>
<p>定义entity、mapper、controller等</p>
</blockquote>
<p>entity</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="c1">// 主键
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="c1">// 昵称
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">nickname</span><span class="o">;</span>
    <span class="c1">// 密码
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="c1">// 年龄
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="o">;</span>
    <span class="c1">// 性别
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">sex</span><span class="o">;</span>
    <span class="c1">// 生日
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Date</span> <span class="n">birthday</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><p>mapper</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc.mapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Insert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Options</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Select</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Mapper</span>
<span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserMapper</span> <span class="o">{</span>

    <span class="nd">@Insert</span><span class="o">(</span><span class="s">&#34;insert into zzs_user(nickname,password,age,sex,birthday) values(#{nickname},#{password},#{age},#{sex},#{birthday})&#34;</span><span class="o">)</span>
    <span class="nd">@Options</span><span class="o">(</span><span class="n">useGeneratedKeys</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">keyColumn</span> <span class="o">=</span> <span class="s">&#34;id&#34;</span><span class="o">,</span><span class="n">keyProperty</span> <span class="o">=</span> <span class="s">&#34;id&#34;</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">addUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="nd">@Select</span><span class="o">(</span><span class="s">&#34;select * from zzs_user&#34;</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findUsers</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><p>controller</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.mapper.UserMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/user&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserMapper</span> <span class="n">userMapper</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/save&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">insert</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setNickname</span><span class="o">(</span><span class="s">&#34;zhangsan&#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&#34;111111&#34;</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setSex</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">userMapper</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&#34;success&#34;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/listuser&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">listuser</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">findUsers</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><blockquote>
<p>查看测试结果</p>
</blockquote>
<p>访问 <code>http://localhost:8085/user/save</code> 一直进入到ds0主节点</p>
<p>访问 <code>http://localhost:8085/user/listuser</code> 一直进入到ds1节点</p>
<blockquote>
<p>run控制台查看日志</p>
</blockquote>
<h3 id="五mysql分库分表原理">五、MySQL分库分表原理</h3>
<h4 id="1为什么要分库分表">1.为什么要分库分表</h4>
<p>解决高并发和数据量大的问题。</p>
<ul>
<li>高并发情况下，会造成IO读写频繁，自然就会造成读写缓慢，甚至是宕机。一般单库不要超过2k并发，性能高的机器除外。</li>
<li>数据量大的问题，主要由于底层索引实现导致，MySQL的索引实现为B+Tree，数据量大会导致索引树十分庞大，造成查询缓慢。innodb的最大存储限制64TB。</li>
</ul>
<h4 id="2分库分表概念">2.分库分表概念</h4>
<p>分为垂直拆分和水平拆分。</p>
<p>**水平拆分：**同一个表的数据拆到不同的库不同的表中。可以根据时间、地区、或某个业务建维度，也可以通过hash进行拆分，最后通过路由访问到具体的数据。拆分后的每个表结构保持一致。</p>
<p>**垂直拆分：**就是把一个有很多字段的表给拆分成多个表，或者多个库上去。每个库表的结构都不一样，每个库表都包含部分字段。一般来说，可以根据业务维度进行拆分，如订单表可以拆分为订单、订单支持、订单地址、订单商品、订单扩展等表；也可以根据数据冷热程度拆分，20%的热点字段拆到一个表，80%的冷字段拆到另外一个表。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c7f0d86e3bedbf0f6bf87d33056b9b93e.png"
        data-srcset="E:%5cNoDishwashingStudio%5c7f0d86e3bedbf0f6bf87d33056b9b93e.png, E:%5cNoDishwashingStudio%5c7f0d86e3bedbf0f6bf87d33056b9b93e.png 1.5x, E:%5cNoDishwashingStudio%5c7f0d86e3bedbf0f6bf87d33056b9b93e.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\7f0d86e3bedbf0f6bf87d33056b9b93e.png"
        title="E:\NoDishwashingStudio\7f0d86e3bedbf0f6bf87d33056b9b93e.png" /></p>
<h4 id="3不停机分库分表数据迁移">3.不停机分库分表数据迁移</h4>
<p>一般数据库的拆分也是有一个过程的，一开始是单表，后面慢慢拆成多表。那么我们就看下如何平滑地从MySQL单表过度到MySQL的分库分表架构。</p>
<ul>
<li>
<p>利用mysql+canal做增量数据同步，利用分库分表中间件，将数据路由到对应的新表中。</p>
</li>
<li>
<p>利用分库分表中间件，全量数据导入到对应的新表中。</p>
</li>
<li>
<p>通过单表数据和分库分表数据两两比较，更新不匹配的数据到新表中。</p>
</li>
<li>
<p>数据稳定后，将单表的配置切换到分库分表配置上。</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c74d7579fbb4fee984ef54d20d6bdf6e3.png"
        data-srcset="E:%5cNoDishwashingStudio%5c74d7579fbb4fee984ef54d20d6bdf6e3.png, E:%5cNoDishwashingStudio%5c74d7579fbb4fee984ef54d20d6bdf6e3.png 1.5x, E:%5cNoDishwashingStudio%5c74d7579fbb4fee984ef54d20d6bdf6e3.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\74d7579fbb4fee984ef54d20d6bdf6e3.png"
        title="E:\NoDishwashingStudio\74d7579fbb4fee984ef54d20d6bdf6e3.png" /></p>
<h4 id="4小结">4.小结</h4>
<p>垂直拆分：业务模块拆分，商品库，用户库，订单库等</p>
<p>水平拆分：对表进行水平拆分</p>
<p>表进行垂直拆分：表的字段过多，字段使用的频率不一（可以拆分两个表建立1 : 1关系）</p>
<h3 id="六shardingjdbc的分库和分表实践">六、ShardingJDBC的分库和分表实践</h3>
<h4 id="1逻辑表">1.逻辑表</h4>
<p>逻辑表：水平拆分时用户数据根据用户id%2拆分为2个表，分别是：zzs_user0和zzs_user1。他们的逻辑表名是：zzs_user。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">    </span><span class="c"># 配置默认数据源ds0</span><span class="w">
</span><span class="w">    </span><span class="nt">sharding</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把这两个节点都当做从slave节点，新增，修改和删除会出错。</span><span class="w">
</span><span class="w">      </span><span class="nt">default-data-source-name</span><span class="p">:</span><span class="w"> </span><span class="l">ds0</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置分表的规则</span><span class="w">
</span><span class="w">      </span><span class="nt">tables</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># zzs_user 逻辑表名</span><span class="w">
</span><span class="w">        </span><span class="nt">zzs_user</span><span class="p">:</span><span class="w">
</span></code></pre></div><h4 id="2数据节点---actual-data-nodes">2.数据节点 - actual-data-nodes</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 配置默认数据源ds0</span><span class="w">
</span><span class="w">    </span><span class="nt">sharding</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把这两个节点都当做从slave节点，新增，修改和删除会出错。</span><span class="w">
</span><span class="w">      </span><span class="nt">default-data-source-name</span><span class="p">:</span><span class="w"> </span><span class="l">ds0</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置分表的规则</span><span class="w">
</span><span class="w">      </span><span class="nt">tables</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># zzs_user 逻辑表名</span><span class="w">
</span><span class="w">        </span><span class="nt">zzs_user</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="c"># 数据节点：数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}</span><span class="w">
</span><span class="w">          </span><span class="nt">actual-data-nodes</span><span class="p">:</span><span class="w"> </span><span class="l">ds$-&gt;{0..1}.zzs_user$-&gt;{0..1}</span><span class="w">
</span></code></pre></div><p>数据节点是最小单元，由数据源名称和数据表组成，比如：ds0.zzs_user0</p>
<p>寻找某个数据的规则如下：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c38bf8afce306037fed0f725894872910.png"
        data-srcset="E:%5cNoDishwashingStudio%5c38bf8afce306037fed0f725894872910.png, E:%5cNoDishwashingStudio%5c38bf8afce306037fed0f725894872910.png 1.5x, E:%5cNoDishwashingStudio%5c38bf8afce306037fed0f725894872910.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\38bf8afce306037fed0f725894872910.png"
        title="E:\NoDishwashingStudio\38bf8afce306037fed0f725894872910.png" /></p>
<h4 id="3分库分表5种分片策略">3.分库分表5种分片策略</h4>
<p>数据分片分为两种：</p>
<ul>
<li>数据源分片</li>
<li>表分片</li>
</ul>
<p>这是两个不同维度的分片规则，但是它们用的分片策略和规则是一样的。它们由两部分构成：</p>
<ul>
<li>分片键</li>
<li>分片算法</li>
</ul>
<h5 id="第一种none">第一种：none</h5>
<p>对应NoneShardingStragey(不分片策略)，SQL会被发给所有节点去执行，这个规则没有子项目可以配置。</p>
<h5 id="第二种inline行表达式分片策略核心必须要掌握">第二种：inline行表达式分片策略(核心，必须要掌握)</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8085</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">main</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">allow-bean-definition-overriding</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">shardingsphere</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># 参数配置，显示sql</span><span class="w">
</span><span class="w">    </span><span class="nt">props</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">sql</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">show</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c"># 配置数据源</span><span class="w">
</span><span class="w">    </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 给每个数据源取别名，下面的ds0,ds1任意取名字</span><span class="w">
</span><span class="w">      </span><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="l">ds0,ds1</span><span class="w">
</span><span class="w">      </span><span class="c"># 给master-ds0每个数据源配置数据库连接信息</span><span class="w">
</span><span class="w">      </span><span class="nt">ds0</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># 配置druid数据源</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource</span><span class="w">
</span><span class="w">        </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://121.40.184.179:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><span class="w">
</span><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span>*<span class="w">
</span><span class="w">        </span><span class="nt">maxPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">        </span><span class="nt">minPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置ds1-slave</span><span class="w">
</span><span class="w">      </span><span class="nt">ds1</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource</span><span class="w">
</span><span class="w">        </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://121.40.100.114:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><span class="w">
</span><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span>*<span class="w">
</span><span class="w">        </span><span class="nt">maxPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">        </span><span class="nt">minPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">    </span><span class="c"># 配置默认数据源ds0</span><span class="w">
</span><span class="w">    </span><span class="nt">sharding</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把这两个节点都当做从slave节点，新增，修改和删除会出错。</span><span class="w">
</span><span class="w">      </span><span class="nt">default-data-source-name</span><span class="p">:</span><span class="w"> </span><span class="l">ds0</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置分表的规则</span><span class="w">
</span><span class="w">      </span><span class="nt">tables</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># zzs_user 逻辑表名</span><span class="w">
</span><span class="w">        </span><span class="nt">zzs_user</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="c"># 数据节点：数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}</span><span class="w">
</span><span class="w">          </span><span class="nt">actual-data-nodes</span><span class="p">:</span><span class="w"> </span><span class="l">ds$-&gt;{0..1}.zzs_user$-&gt;{0..1}</span><span class="w">
</span><span class="w">          </span><span class="c"># 拆分库策略，也就是什么样子的数据放入放到哪个数据库中。</span><span class="w">
</span><span class="w">          </span><span class="nt">database-strategy</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">inline</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">sharding-column</span><span class="p">:</span><span class="w"> </span><span class="l">sex   </span><span class="w"> </span><span class="c"># 分片字段（分片键）</span><span class="w">
</span><span class="w">              </span><span class="nt">algorithm-expression</span><span class="p">:</span><span class="w"> </span><span class="l">ds$-&gt;{sex % 2}</span><span class="w"> </span><span class="c"># 分片算法表达式</span><span class="w">
</span><span class="w">          </span><span class="c"># 拆分表策略，也就是什么样子的数据放入放到哪个数据表中。</span><span class="w">
</span><span class="w">          </span><span class="nt">table-strategy</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">inline</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">sharding-column</span><span class="p">:</span><span class="w"> </span><span class="l">age   </span><span class="w"> </span><span class="c"># 分片字段（分片键）</span><span class="w">
</span><span class="w">              </span><span class="nt">algorithm-expression</span><span class="p">:</span><span class="w"> </span><span class="l">zzs_user$-&gt;{age % 2}</span><span class="w"> </span><span class="c"># 分片算法表达式</span><span class="w">
</span><span class="w"></span><span class="c">#    # 配置数据源的读写分离，但是数据库一定要做主从复制</span><span class="w">
</span><span class="w"></span><span class="c">#    masterslave:</span><span class="w">
</span><span class="w"></span><span class="c">#      # 配置主从名称，可以任意取名字</span><span class="w">
</span><span class="w"></span><span class="c">#      name: ms</span><span class="w">
</span><span class="w"></span><span class="c">#      # 配置主库master，负责数据的写入</span><span class="w">
</span><span class="w"></span><span class="c">#      master-data-source-name: ds0</span><span class="w">
</span><span class="w"></span><span class="c">#      # 配置从库slave节点</span><span class="w">
</span><span class="w"></span><span class="c">#      slave-data-source-names: ds1</span><span class="w">
</span><span class="w"></span><span class="c">#      # 配置slave节点的负载均衡均衡策略，采用轮询机制</span><span class="w">
</span><span class="w"></span><span class="c">#      load-balance-algorithm-type: round_robin</span><span class="w">
</span><span class="w"></span><span class="c"># 整合mybatis的配置XXXXX</span><span class="w">
</span><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">mapper-locations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:mapper/*.xml</span><span class="w">
</span><span class="w">  </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com.zzs.shardingJdbc.entity</span><span class="w">
</span></code></pre></div><ul>
<li>在每个数据源下的zzs_order_db库中建zzs_user0和zzs_user1表。</li>
<li>数据源规则：性别为偶数的放入ds0库，奇数的放入ds1库。</li>
<li>数据表规则：年龄为偶数的放入zzs_user0表中，奇数的放入zzs_user1表中。</li>
</ul>
<h5 id="第三种standard标准分片策略">第三种：standard标准分片策略</h5>
<p><strong>标准分片策略(了解即可)</strong></p>
<ul>
<li>
<p>对应StrandardShardingStrategy，提供对SQL语句中的=，in和between and的分片操作支持。</p>
<p>但StrandardShardingStrategy只支持分片键，但它提供了PreciseShardingAlgorithm和RangeShardingAlgorithm两个分片算法。</p>
</li>
<li>
<p>PreciseShardingAlgorithm是必选的，用于处理=和in的分片。</p>
</li>
<li>
<p>RangeShardingAlgorithm是可选的，是用于处理between and分片，如果不配置和RangeShardingAlgorithm，SQL的between and将按照全库路由处理。</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c0b4f58f74bac6b5baf843683f3213d20.png"
        data-srcset="E:%5cNoDishwashingStudio%5c0b4f58f74bac6b5baf843683f3213d20.png, E:%5cNoDishwashingStudio%5c0b4f58f74bac6b5baf843683f3213d20.png 1.5x, E:%5cNoDishwashingStudio%5c0b4f58f74bac6b5baf843683f3213d20.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\0b4f58f74bac6b5baf843683f3213d20.png"
        title="E:\NoDishwashingStudio\0b4f58f74bac6b5baf843683f3213d20.png" /></p>
<p><strong>自定义标准分片策略&mdash;按照日期(需要extend标准分片策略类)</strong></p>
<blockquote>
<p>配置文件</p>
</blockquote>
<pre tabindex="0"><code class="language-yam" data-lang="yam">server:
  port: 8085
spring:
  main:
    allow-bean-definition-overriding: true
  shardingsphere:
    # 参数配置，显示sql
    props:
      sql:
        show: true
    # 配置数据源
    datasource:
      # 给每个数据源取别名，下面的ds0,ds1任意取名字
      names: ds0,ds1
      # 给master-ds0每个数据源配置数据库连接信息
      ds0:
        # 配置druid数据源
        type: com.alibaba.druid.pool.DruidDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://121.40.184.179:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT
        username: root
        password: *
        maxPoolSize: 100
        minPoolSize: 5
      # 配置ds1-slave
      ds1:
        type: com.alibaba.druid.pool.DruidDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://121.40.100.114:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT
        username: root
        password: *
        maxPoolSize: 100
        minPoolSize: 5
    # 配置默认数据源ds0
    sharding:
      # 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把这两个节点都当做从slave节点，新增，修改和删除会出错。
      default-data-source-name: ds0
      # 配置分表的规则
      tables:
        # zzs_user 逻辑表名
        zzs_user:
          # 数据节点：数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}
          actual-data-nodes: ds$-&gt;{0..1}.zzs_user$-&gt;{0..1}
          # 拆分库策略，也就是什么样子的数据放入放到哪个数据库中。
          database-strategy:
            standard:
              shardingColumn: birthday    # 分片字段（分片键）
              preciseAlgorithmClassName: com.zzs.shardingJdbc.algorithm.BirthdayAlgorithm # 分片算法表达式
          # 拆分表策略，也就是什么样子的数据放入放到哪个数据表中。
          table-strategy:
            inline:
              sharding-column: age    # 分片字段（分片键）
              algorithm-expression: zzs_user$-&gt;{age % 2} # 分片算法表达式
#    # 配置数据源的读写分离，但是数据库一定要做主从复制
#    masterslave:
#      # 配置主从名称，可以任意取名字
#      name: ms
#      # 配置主库master，负责数据的写入
#      master-data-source-name: ds0
#      # 配置从库slave节点
#      slave-data-source-names: ds1
#      # 配置slave节点的负载均衡均衡策略，采用轮询机制
#      load-balance-algorithm-type: round_robin
# 整合mybatis的配置XXXXX
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.zzs.shardingJdbc.entity
</code></pre><blockquote>
<p>自定义的算法类</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc.algorithm</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shardingsphere.api.sharding.standard.PreciseShardingAlgorithm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shardingsphere.api.sharding.standard.PreciseShardingValue</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Calendar</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BirthdayAlgorithm</span> <span class="kd">implements</span> <span class="n">PreciseShardingAlgorithm</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span> <span class="n">dateList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">{</span>
        <span class="n">Calendar</span> <span class="n">calendar1</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
        <span class="n">calendar1</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">2022</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="n">Calendar</span> <span class="n">calendar2</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
        <span class="n">calendar2</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">2023</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="n">dateList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">calendar1</span><span class="o">.</span><span class="na">getTime</span><span class="o">());</span>
        <span class="n">dateList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">calendar2</span><span class="o">.</span><span class="na">getTime</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">doSharding</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">,</span> <span class="n">PreciseShardingValue</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span> <span class="n">preciseShardingValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 获取属性数据库的值
</span><span class="c1"></span>        <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="n">preciseShardingValue</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="c1">// 获取数据源的名称信息列表
</span><span class="c1"></span>        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">target</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Date</span> <span class="n">s</span> <span class="o">:</span> <span class="n">dateList</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="c1">// 如果数据晚于指定的日期直接返回
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">date</span><span class="o">.</span><span class="na">before</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">target</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><blockquote>
<p>查看测试结果</p>
</blockquote>
<h5 id="第四种complex复合分片策略了解">第四种：complex复合分片策略（了解）</h5>
<ul>
<li>对应ComplexShardingStrategy。复合分片策略提供对SQL语句中的=，in和between and的分片操作支持。</li>
<li>ComplexShardingStrategy支持多分片键，由于多分片键之间的关系复杂，因此并未进行过多的封装，完全由开发者自己实现，提供最大的灵活度。</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5c69613e757df2a6939e92087fde2097ba.png"
        data-srcset="E:%5cNoDishwashingStudio%5c69613e757df2a6939e92087fde2097ba.png, E:%5cNoDishwashingStudio%5c69613e757df2a6939e92087fde2097ba.png 1.5x, E:%5cNoDishwashingStudio%5c69613e757df2a6939e92087fde2097ba.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\69613e757df2a6939e92087fde2097ba.png"
        title="E:\NoDishwashingStudio\69613e757df2a6939e92087fde2097ba.png" /></p>
<h5 id="第五种hint分片策略了解">第五种：hint分片策略（了解）</h5>
<ul>
<li>对应接口：HintShardingStrategy。通过Hint而非SQL解析的方式的分片策略。</li>
<li>对于分片字段非SQL决定，而是由其他外置条件决定的场景，可使用SQL hint灵活的注入分片字段。例如：按照用户登录的时间，主键等进行分库，而数据库中并无此字段。SQL hint支持通过Java API和SQL注解两种方式使用。让分库分表更加灵活。</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="E:%5cNoDishwashingStudio%5cbc9bda0c7c525216b91af7cbf38cae11.png"
        data-srcset="E:%5cNoDishwashingStudio%5cbc9bda0c7c525216b91af7cbf38cae11.png, E:%5cNoDishwashingStudio%5cbc9bda0c7c525216b91af7cbf38cae11.png 1.5x, E:%5cNoDishwashingStudio%5cbc9bda0c7c525216b91af7cbf38cae11.png 2x"
        data-sizes="auto"
        alt="E:\NoDishwashingStudio\bc9bda0c7c525216b91af7cbf38cae11.png"
        title="E:\NoDishwashingStudio\bc9bda0c7c525216b91af7cbf38cae11.png" /></p>
<h3 id="七分布式主键配置">七、分布式主键配置</h3>
<p>ShardingSphere提供灵活地配置分布式主键生成策略方式，在分片规则配置模块可配置每个表的主键生成策略。默认使用雪花算法，（snowflake）生成64bit的长整型数据。支持两种方式配置：</p>
<ul>
<li>SNOWFLAKE</li>
<li>UUID</li>
</ul>
<p>这里切记：主键列不能自增长。数据类型是：bigint(20)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 配置默认数据源ds0</span><span class="w">
</span><span class="w">    </span><span class="nt">sharding</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把这两个节点都当做从slave节点，新增，修改和删除会出错。</span><span class="w">
</span><span class="w">      </span><span class="nt">default-data-source-name</span><span class="p">:</span><span class="w"> </span><span class="l">ds0</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置分表的规则</span><span class="w">
</span><span class="w">      </span><span class="nt">tables</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># zzs_user 逻辑表名</span><span class="w">
</span><span class="w">        </span><span class="nt">zzs_user</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">key-generator</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="c"># 主键的列明，</span><span class="w">
</span><span class="w">            </span><span class="nt">column</span><span class="p">:</span><span class="w"> </span><span class="l">id</span><span class="w">
</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">SNOWFLAKE</span><span class="w">
</span><span class="w">          </span><span class="c"># 数据节点：数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}</span><span class="w">
</span><span class="w">          </span><span class="nt">actual-data-nodes</span><span class="p">:</span><span class="w"> </span><span class="l">ds$-&gt;{0..1}.zzs_user$-&gt;{0..1}</span><span class="w">
</span></code></pre></div><blockquote>
<p>执行查看结果</p>
</blockquote>
<h3 id="八分库分表---按年月来分案例">八、分库分表 - 按年月来分案例</h3>
<h4 id="1规则类">1.规则类</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc.algorithm</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shardingsphere.api.sharding.standard.PreciseShardingAlgorithm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shardingsphere.api.sharding.standard.PreciseShardingValue</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">YearMonthShardingAlgorithm</span> <span class="kd">implements</span> <span class="n">PreciseShardingAlgorithm</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SPLITTER</span> <span class="o">=</span> <span class="s">&#34;_&#34;</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">doSharding</span><span class="o">(</span><span class="n">Collection</span> <span class="n">availableTargetNames</span><span class="o">,</span> <span class="n">PreciseShardingValue</span> <span class="n">shardingValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">tbName</span> <span class="o">=</span> <span class="n">shardingValue</span><span class="o">.</span><span class="na">getLogicTableName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;_&#34;</span> <span class="o">+</span> <span class="n">shardingValue</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Sharding input:&#34;</span> <span class="o">+</span> <span class="n">shardingValue</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;, output:{}&#34;</span> <span class="o">+</span> <span class="n">tbName</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">tbName</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h4 id="2entity">2.entity</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserOrder</span> <span class="o">{</span>
    <span class="c1">// 主键
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">orderid</span><span class="o">;</span>
    <span class="c1">// 用户ID
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userid</span><span class="o">;</span>
    <span class="c1">// 订单编号
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">ordernumber</span><span class="o">;</span>
    <span class="c1">// 创建时间
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createTime</span><span class="o">;</span>
    <span class="c1">// 年月
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">yearmonth</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><h4 id="3mapper">3.mapper</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc.mapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.entity.UserOrder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Insert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Options</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span>

<span class="nd">@Mapper</span>
<span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserOrderMapper</span> <span class="o">{</span>

    <span class="nd">@Insert</span><span class="o">(</span><span class="s">&#34;insert into zzs_user_order(userid,ordernumber,createTime,yearmonth) values(#{userid},#{ordernumber},#{createTime},#{yearmonth})&#34;</span><span class="o">)</span>
    <span class="nd">@Options</span><span class="o">(</span><span class="n">useGeneratedKeys</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">keyColumn</span> <span class="o">=</span> <span class="s">&#34;orderid&#34;</span><span class="o">,</span><span class="n">keyProperty</span> <span class="o">=</span> <span class="s">&#34;orderid&#34;</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">addUserOrder</span><span class="o">(</span><span class="n">UserOrder</span> <span class="n">userOrder</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h4 id="4配置">4.配置</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8085</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">main</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">allow-bean-definition-overriding</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">shardingsphere</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># 参数配置，显示sql</span><span class="w">
</span><span class="w">    </span><span class="nt">props</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">sql</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">show</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c"># 配置数据源</span><span class="w">
</span><span class="w">    </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 给每个数据源取别名，下面的ds0,ds1任意取名字</span><span class="w">
</span><span class="w">      </span><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="l">ds0,ds1</span><span class="w">
</span><span class="w">      </span><span class="c"># 给master-ds0每个数据源配置数据库连接信息</span><span class="w">
</span><span class="w">      </span><span class="nt">ds0</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># 配置druid数据源</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource</span><span class="w">
</span><span class="w">        </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://121.40.184.179:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><span class="w">
</span><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span>*<span class="w">
</span><span class="w">        </span><span class="nt">maxPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">        </span><span class="nt">minPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置ds1-slave</span><span class="w">
</span><span class="w">      </span><span class="nt">ds1</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource</span><span class="w">
</span><span class="w">        </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://121.40.100.114:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><span class="w">
</span><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span>*<span class="w">
</span><span class="w">        </span><span class="nt">maxPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">        </span><span class="nt">minPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">    </span><span class="c"># 配置默认数据源ds0</span><span class="w">
</span><span class="w">    </span><span class="nt">sharding</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把这两个节点都当做从slave节点，新增，修改和删除会出错。</span><span class="w">
</span><span class="w">      </span><span class="nt">default-data-source-name</span><span class="p">:</span><span class="w"> </span><span class="l">ds0</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置分表的规则</span><span class="w">
</span><span class="w">      </span><span class="nt">tables</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">zzs_user_order</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="c"># 数据节点：数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}</span><span class="w">
</span><span class="w">          </span><span class="nt">actual-data-nodes</span><span class="p">:</span><span class="w"> </span><span class="l">ds0.zzs_user_order_$-&gt;{2021..2022}${(1..3).collect{t -&gt;t.toString().padLeft(2,&#39;0&#39;)} }</span><span class="w">
</span><span class="w">          </span><span class="nt">key-generator</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">column</span><span class="p">:</span><span class="w"> </span><span class="l">orderid</span><span class="w">
</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">SNOWFLAKE</span><span class="w">
</span><span class="w">          </span><span class="c"># 拆分表策略，也就是什么样子的数据放入放到哪个数据表中。</span><span class="w">
</span><span class="w">          </span><span class="nt">table-strategy</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">standard</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">shardingColumn</span><span class="p">:</span><span class="w"> </span><span class="l">yearmonth</span><span class="w">
</span><span class="w">              </span><span class="nt">preciseAlgorithmClassName</span><span class="p">:</span><span class="w"> </span><span class="l">com.zzs.shardingJdbc.algorithm.YearMonthShardingAlgorithm</span><span class="w">
</span><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">mapper-locations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:mapper/*.xml</span><span class="w">
</span><span class="w">  </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com.zzs.shardingJdbc.entity</span><span class="w">
</span></code></pre></div><h4 id="5测试">5.测试</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.entity.UserOrder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.mapper.UserOrderMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="nd">@SpringBootTest</span>
<span class="kd">class</span> <span class="nc">ShardingJdbcApplicationTests</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserOrderMapper</span> <span class="n">userOrderMapper</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">orderyearMaster</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">UserOrder</span> <span class="n">userOrder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserOrder</span><span class="o">();</span>
        <span class="n">userOrder</span><span class="o">.</span><span class="na">setUserid</span><span class="o">(</span><span class="n">1L</span><span class="o">);</span>
        <span class="n">userOrder</span><span class="o">.</span><span class="na">setOrdernumber</span><span class="o">(</span><span class="s">&#34;133455678&#34;</span><span class="o">);</span>
        <span class="n">userOrder</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">userOrder</span><span class="o">.</span><span class="na">setYearmonth</span><span class="o">(</span><span class="s">&#34;202203&#34;</span><span class="o">);</span>
        <span class="n">userOrderMapper</span><span class="o">.</span><span class="na">addUserOrder</span><span class="o">(</span><span class="n">userOrder</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>如果不使用标准分片策略(standard)，而选择使用inline分片策略，则不需要写规则类，再将配置文件修改为：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8085</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">main</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">allow-bean-definition-overriding</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">shardingsphere</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># 参数配置，显示sql</span><span class="w">
</span><span class="w">    </span><span class="nt">props</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">sql</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">show</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c"># 配置数据源</span><span class="w">
</span><span class="w">    </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 给每个数据源取别名，下面的ds0,ds1任意取名字</span><span class="w">
</span><span class="w">      </span><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="l">ds0,ds1</span><span class="w">
</span><span class="w">      </span><span class="c"># 给master-ds0每个数据源配置数据库连接信息</span><span class="w">
</span><span class="w">      </span><span class="nt">ds0</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># 配置druid数据源</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource</span><span class="w">
</span><span class="w">        </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://121.40.184.179:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><span class="w">
</span><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span>*<span class="w">
</span><span class="w">        </span><span class="nt">maxPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">        </span><span class="nt">minPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置ds1-slave</span><span class="w">
</span><span class="w">      </span><span class="nt">ds1</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource</span><span class="w">
</span><span class="w">        </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://121.40.100.114:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT</span><span class="w">
</span><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span>*<span class="w">
</span><span class="w">        </span><span class="nt">maxPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">        </span><span class="nt">minPoolSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">    </span><span class="c"># 配置默认数据源ds0</span><span class="w">
</span><span class="w">    </span><span class="nt">sharding</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把这两个节点都当做从slave节点，新增，修改和删除会出错。</span><span class="w">
</span><span class="w">      </span><span class="nt">default-data-source-name</span><span class="p">:</span><span class="w"> </span><span class="l">ds0</span><span class="w">
</span><span class="w">      </span><span class="c"># 配置分表的规则</span><span class="w">
</span><span class="w">      </span><span class="nt">tables</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">zzs_user_order</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="c"># 数据节点：数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}</span><span class="w">
</span><span class="w">          </span><span class="nt">actual-data-nodes</span><span class="p">:</span><span class="w"> </span><span class="l">ds0.zzs_user_order_$-&gt;{2021..2022}${(1..3).collect{t -&gt;t.toString().padLeft(2,&#39;0&#39;)} }</span><span class="w">
</span><span class="w">          </span><span class="nt">key-generator</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">column</span><span class="p">:</span><span class="w"> </span><span class="l">orderid</span><span class="w">
</span><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">SNOWFLAKE</span><span class="w">
</span><span class="w">          </span><span class="c"># 拆分表策略，也就是什么样子的数据放入放到哪个数据表中。</span><span class="w">
</span><span class="w">          </span><span class="nt">table-strategy</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">inline</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">shardingColumn</span><span class="p">:</span><span class="w"> </span><span class="l">yearmonth</span><span class="w">
</span><span class="w">              </span><span class="nt">algorithmExpression</span><span class="p">:</span><span class="w"> </span><span class="l">zzs_user_order_$-&gt;{yearmonth}</span><span class="w">
</span><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">mapper-locations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:mapper/*.xml</span><span class="w">
</span><span class="w">  </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com.zzs.shardingJdbc.entity</span><span class="w">
</span></code></pre></div><h3 id="九shardingjdbc的事务管理">九、ShardingJDBC的事务管理</h3>
<h4 id="1分布式事务的简单认识">1.分布式事务的简单认识</h4>
<p>数据库事务需要满足ACID（原子性、一致性、隔离性、持久性）四个特性。</p>
<ul>
<li>原子性（Atomicity）指事务作为整体来执行，要么全部执行，要么全不执行。</li>
<li>一致性（Consistency）指事务应确保数据从一个一致的状态转变为另一个一致的状态。</li>
<li>隔离性（Isolation）指多个事务并发执行时，一个事务的执行不应影响其他事务的执行。</li>
<li>持久性（Durability）指已提交的事务修改数据会被持久保存。</li>
</ul>
<p>在单一数据节点中，事务仅限于对单一数据库资源的访问控制，称之为本地事务。几乎所有的成熟的关系型数据库都提供了对本地事务的原生支持。 但是在基于微服务的分布式应用环境下，越来越多的应用场景要求对多个服务的访问及其相对应的多个数据库资源能纳入到同一个事务当中，分布式事务应运而生。关系型数据库虽然对本地事务提供了完美的ACID原生支持。 但在分布式的场景下，它却成为系统性能的桎梏。如何让数据库在分布式场景下满足ACID的特性或找寻相应的替代方案，是分布式事务的重点工作。</p>
<blockquote>
<p>本地事务</p>
</blockquote>
<p>在不开启任何分布式事务管理器的前提下，让每个数据节点各自管理自己的事务。 它们之间没有协调以及通信的能力，也并不互相知晓其他数据节点事务的成功与否。 本地事务在性能方面无任何损耗，但在强一致性以及最终一致性方面则力不从心。</p>
<blockquote>
<p>两阶段提交</p>
</blockquote>
<p>XA协议，最早的分布式事务模型是由X/Open国际联盟提出的X/Open Distributed Transaction Processing（DTP）模型，简称XA协议。</p>
<p>基于XA协议实现的分布式事务对业务侵入很小。 它最大的优势就是对使用方透明，用户可以像使用本地事务一样使用基于XA协议的分布式事务。 XA协议能够严格保障事务ACID特性。</p>
<p>严格保障事务ACID特性是一把双刃剑。 事务执行在过程中需要将所需资源全部锁定，它更加适用于执行时间确定的短事务。 对于长事务来说，整个事务进行期间对数据的独占，将导致对热点数据依赖的业务系统并发性能衰退明显。 因此，在高并发的性能至上场景中，基于XA协议的分布式事务并不是最佳选择。</p>
<blockquote>
<p>柔性事务</p>
</blockquote>
<p>如果将实现了ACID的事务要素的事务称为刚性事务的话，那么基于BASE事务要素的事务则称为柔性事务。 BASE是基本可用、柔性状态和最终一致性这三个要素的缩写。</p>
<p>基本可用（Basically Available）保证分布式事务参与方不一定同时在线。
柔性状态（Soft state）则允许系统状态更新有一定的延时，这个延时对客户来说不一定能够察觉。
而最终一致性（Eventually consistent）通常是通过消息传递的方式保证系统的最终一致性。</p>
<p>在ACID事务中对隔离性的要求很高，在事务执行过程中，必须将所有的资源锁定。 柔性事务的理念则是通过业务逻辑将互斥锁操作从资源层面上移至业务层面。通过放宽对强一致性要求，来换取系统吞吐量的提升。</p>
<p>基于ACID的强一致性事务和基于BASE的最终一致性事务都不是银弹，只有在最适合的场景中才能发挥它们的最大长处。 可通过下表详细对比它们之间的区别，以帮助开发者进行技术选型。</p>
<h4 id="2具体案例">2.具体案例</h4>
<blockquote>
<p>导入分布式事务的依赖</p>
</blockquote>
<pre tabindex="0"><code class="language-pom" data-lang="pom"> &lt;!--依赖sharding--&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;io.shardingsphere&lt;/groupId&gt;
     &lt;artifactId&gt;sharding-transaction-spring-boot-starter&lt;/artifactId&gt;
     &lt;version&gt;3.1.0&lt;/version&gt;
 &lt;/dependency&gt;
</code></pre><blockquote>
<p>事务的几种类型</p>
</blockquote>
<p><strong>本地事务</strong></p>
<ul>
<li>完全支持非跨库事务，例如：仅分表或分库但是路由的结果在单库中。</li>
<li>完全支持因逻辑异常导致的跨库事务。例如：同一事务中，跨两个库更新，更新完毕后，抛出空指针，则两个库的内容都能回滚。</li>
<li>不支持因网络、硬件异常导致的跨库事务。例如：同一事务中，跨两个库更新，更新完毕后，未提交之前，第一个库宕机，则只有第二个库数据提交。</li>
</ul>
<p><strong>两阶段XA事务</strong></p>
<ul>
<li>
<p>支持数据分片后的跨库XA事务</p>
</li>
<li>
<p>两阶段提交保证操作的原子性和数据的强一致性</p>
</li>
<li>
<p>服务宕机重启后，提交/回滚中的事务可自动恢复</p>
</li>
<li>
<p>SPI机制整合主流的XA事务管理器，默认Atomikos，可以选择使用Narayana和Bitronix
同时支持XA和非XA的连接池</p>
</li>
<li>
<p>提供spring-boot和namespace的接入端</p>
</li>
<li>
<p>不支持服务宕机后，在其它机器上恢复提交/回滚中的数据</p>
</li>
</ul>
<p><strong>Seata柔性事务</strong></p>
<ul>
<li>完全支持跨库分布式事务</li>
<li>支持RC隔离级别</li>
<li>通过undo快照进行事务回滚</li>
<li>支持服务宕机后的，自动恢复提交中的事务</li>
</ul>
<p>依赖：</p>
<ul>
<li>需要额外部署Seata-server服务进行分支事务的协调
待优化项</li>
<li>ShardingSphere和Seata会对SQL进行重复解析</li>
</ul>
<blockquote>
<p>Order实体类</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc.entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="c1">// 主键
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">orderid</span><span class="o">;</span>
    <span class="c1">// 订单编号
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">ordernumber</span><span class="o">;</span>
    <span class="c1">// 用户ID
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userid</span><span class="o">;</span>
    <span class="c1">// 产品id
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">productid</span><span class="o">;</span>
    <span class="c1">// 创建时间
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createTime</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div><blockquote>
<p>OrderMapper</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc.mapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.entity.Order</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Insert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Options</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span>

<span class="nd">@Mapper</span>
<span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderMapper</span> <span class="o">{</span>

    <span class="nd">@Insert</span><span class="o">(</span><span class="s">&#34;insert into zzs_order(ordernumber,userid,productid,createTime) values(#{ordernumber},#{userid},#{productid},#{createTime})&#34;</span><span class="o">)</span>
    <span class="nd">@Options</span><span class="o">(</span><span class="n">useGeneratedKeys</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">keyColumn</span> <span class="o">=</span> <span class="s">&#34;orderid&#34;</span><span class="o">,</span><span class="n">keyProperty</span> <span class="o">=</span> <span class="s">&#34;orderid&#34;</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">addOrder</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><blockquote>
<p>配置文件</p>
</blockquote>
<pre tabindex="0"><code class="language-yam" data-lang="yam">server:
  port: 8085
spring:
  main:
    allow-bean-definition-overriding: true
  shardingsphere:
    # 参数配置，显示sql
    props:
      sql:
        show: true
    # 配置数据源
    datasource:
      # 给每个数据源取别名，下面的ds0,ds1任意取名字
      names: ds0,ds1
      # 给master-ds0每个数据源配置数据库连接信息
      ds0:
        # 配置druid数据源
        type: com.alibaba.druid.pool.DruidDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://121.40.184.179:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT
        username: root
        password: *
        maxPoolSize: 100
        minPoolSize: 5
      # 配置ds1-slave
      ds1:
        type: com.alibaba.druid.pool.DruidDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://121.40.100.114:3306/zzs_order_db?useUnicode=true&amp;characterEncoding=utf8&amp;tinyInt1isBit=false&amp;useSSL=false&amp;serverTimezone=GMT
        username: root
        password: *
        maxPoolSize: 100
        minPoolSize: 5
    # 配置默认数据源ds0
    sharding:
      # 默认数据源，主要用于写，注意一定要配置读写分离 ,注意：如果不配置，那么就会把这两个节点都当做从slave节点，新增，修改和删除会出错。
      default-data-source-name: ds0
      # 配置分表的规则
      tables:
        # zzs_user 逻辑表名
        zzs_user:
          key-generator:
            # 主键的列明，
            column: id
            type: SNOWFLAKE
          # 数据节点：数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}
          actual-data-nodes: ds$-&gt;{0..1}.zzs_user$-&gt;{0..1}
          # 拆分库策略，也就是什么样子的数据放入放到哪个数据库中。
          database-strategy:
            standard:
              shardingColumn: birthday    # 分片字段（分片键）
              preciseAlgorithmClassName: com.zzs.shardingJdbc.algorithm.BirthdayAlgorithm # 分片算法表达式
          # 拆分表策略，也就是什么样子的数据放入放到哪个数据表中。
          table-strategy:
            inline:
              sharding-column: age    # 分片字段（分片键）
              algorithm-expression: zzs_user$-&gt;{age % 2} # 分片算法表达式
        zzs_order:
          # 数据节点：数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}
          actual-data-nodes: ds0.zzs_order$-&gt;{0..1}
          key-generator:
            column: orderid
            type: SNOWFLAKE
          # 拆分表策略，也就是什么样子的数据放入放到哪个数据表中。
          table-strategy:
            inline:
              sharding-column: orderid    # 分片字段（分片键）
              algorithm-expression: zzs_order$-&gt;{orderid % 2} # 分片算法表达式
        zzs_user_order:
          # 数据节点：数据源$-&gt;{0..N}.逻辑表名$-&gt;{0..N}
          actual-data-nodes: ds0.zzs_user_order_$-&gt;{2021..2022}${(1..3).collect{t -&gt;t.toString().padLeft(2,'0')} }
          key-generator:
            column: orderid
            type: SNOWFLAKE
          # 拆分表策略，也就是什么样子的数据放入放到哪个数据表中。
          table-strategy:
#            inline:
#              shardingColumn: yearmonth
#              algorithmExpression: zzs_user_order_$-&gt;{yearmonth}
            standard:
              shardingColumn: yearmonth
              preciseAlgorithmClassName: com.zzs.shardingJdbc.algorithm.YearMonthShardingAlgorithm
# 整合mybatis的配置XXXXX
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.zzs.shardingJdbc.entity
</code></pre><blockquote>
<p>service层代码编写</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.entity.Order</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.mapper.OrderMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.mapper.UserMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.shardingsphere.transaction.annotation.ShardingTransactionType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.shardingsphere.transaction.api.TransactionType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserOrderService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserMapper</span> <span class="n">userMapper</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">OrderMapper</span> <span class="n">orderMapper</span><span class="o">;</span>

    <span class="nd">@ShardingTransactionType</span><span class="o">(</span><span class="n">TransactionType</span><span class="o">.</span><span class="na">XA</span><span class="o">)</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">rollbackFor</span> <span class="o">=</span> <span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">saveUserOrder</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">,</span> <span class="n">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">userMapper</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">order</span><span class="o">.</span><span class="na">setUserid</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
		<span class="c1">// int a = 1/0; //测试回滚，统一提交的话，将这行注释掉就行
</span><span class="c1"></span>        <span class="n">orderMapper</span><span class="o">.</span><span class="na">addOrder</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><blockquote>
<p>测试</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.zzs.shardingJdbc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.entity.Order</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.entity.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zzs.shardingJdbc.service.UserOrderService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="nd">@SpringBootTest</span>
<span class="kd">class</span> <span class="nc">ShardingJdbcApplicationTests</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserOrderService</span> <span class="n">userOrderService</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setNickname</span><span class="o">(</span><span class="s">&#34;zhangsan&#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&#34;1234567&#34;</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setSex</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">();</span>
        <span class="n">order</span><span class="o">.</span><span class="na">setOrdernumber</span><span class="o">(</span><span class="s">&#34;133455678&#34;</span><span class="o">);</span>
        <span class="n">order</span><span class="o">.</span><span class="na">setProductid</span><span class="o">(</span><span class="n">1234L</span><span class="o">);</span>
        <span class="n">order</span><span class="o">.</span><span class="na">setCreateTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">userOrderService</span><span class="o">.</span><span class="na">saveUserOrder</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">order</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>还有一些相关面试题和知识点可参考文章：<a href="https://blog.csdn.net/qq_44866424/article/details/120009099" target="_blank" rel="noopener noreffer">https://blog.csdn.net/qq_44866424/article/details/120009099</a></p>
<p>视频可参考狂神说ShardingJDBC讲解：<a href="https://www.bilibili.com/video/BV1ei4y1K7dn" target="_blank" rel="noopener noreffer">https://www.bilibili.com/video/BV1ei4y1K7dn</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-03-27</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a>,&nbsp;<a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/">数据库中间件</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/fetchapi%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%9F%BA%E7%A1%80/" class="prev" rel="prev" title="Fetch()API及相关基础"><i class="fas fa-angle-left fa-fw"></i>Fetch()API及相关基础</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.90.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
