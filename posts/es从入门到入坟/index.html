<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>ES从入门到入坟 - 不洗碗工作室公共博客</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="ES从入门到入坟" />
<meta property="og:description" content="@[TOC] 一.elasticsearch简介 Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/es%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-13T18:54:43+08:00" />
<meta property="article:modified_time" content="2022-02-13T18:54:43+08:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ES从入门到入坟"/>
<meta name="twitter:description" content="@[TOC] 一.elasticsearch简介 Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/posts/es%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/" /><link rel="prev" href="http://example.org/posts/%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83/" /><link rel="next" href="http://example.org/posts/%E7%AE%80%E8%B0%88%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8F%8A%E6%B8%B2%E6%9F%93/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "ES从入门到入坟",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/posts\/es%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F\/"
        },"genre": "posts","keywords": "技术分享, ES","wordcount":  11628 ,
        "url": "http:\/\/example.org\/posts\/es%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F\/","datePublished": "2022-02-13T18:54:43+08:00","dateModified": "2022-02-13T18:54:43+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "姚辉"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="不洗碗工作室公共博客">My cool site</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="不洗碗工作室公共博客">My cool site</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ES从入门到入坟</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/Henrik-Yao" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>姚辉</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/es/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>ES</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-02-13">2022-02-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 11628 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 24 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一elasticsearch简介">一.elasticsearch简介</a></li>
    <li><a href="#二docker部署es和kibana">二.docker部署es和kibana</a></li>
    <li><a href="#三ik分词器">三.IK分词器</a></li>
    <li><a href="#四dsl及dev-tools">四.DSL及Dev Tools</a></li>
    <li><a href="#五索引库操作">五.索引库操作</a></li>
    <li><a href="#五文档操作">五.文档操作</a></li>
    <li><a href="#六restclient操作索引库">六.RestClient操作索引库</a></li>
    <li><a href="#七restclient操作文档">七.RestClient操作文档</a></li>
    <li><a href="#八dsl查询语法">八.DSL查询语法</a></li>
    <li><a href="#九搜索结果处理">九.搜索结果处理</a></li>
    <li><a href="#十restclient查询文档">十.RestClient查询文档</a></li>
    <li><a href="#十一数据聚合">十一.数据聚合</a></li>
    <li><a href="#十二restclient数据聚合">十二.RestClient数据聚合</a></li>
    <li><a href="#十三自动补全">十三.自动补全</a></li>
    <li><a href="#十四数据同步">十四.数据同步</a></li>
    <li><a href="#十五es集群">十五.ES集群</a></li>
    <li><a href="#十六附录">十六.附录</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>@[TOC]</p>
<h2 id="一elasticsearch简介">一.elasticsearch简介</h2>
<blockquote>
<p><strong>Elasticsearch</strong>是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于<strong>RESTful web</strong>接口。Elasticsearch是用Java语言开发的，并作为Apache许可条款下的开放源码发布，是一种流行的企业级搜索引擎。Elasticsearch用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。
<strong>Lucene</strong>是Apache的开源搜索引擎类库，提供了搜索引擎的核心API</p>
</blockquote>
<blockquote>
<p>mysql采用正向索引（B树，B+树）</p>
<p>elasticsearch采用倒排索引</p>
</blockquote>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/4c55ecd9759d4090ab500ae961d2a34f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/4c55ecd9759d4090ab500ae961d2a34f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/4c55ecd9759d4090ab500ae961d2a34f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/4c55ecd9759d4090ab500ae961d2a34f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/4c55ecd9759d4090ab500ae961d2a34f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<blockquote>
<p>Mysql：擅长事务类型操作，可以确保数据的安全和一致性</p>
<p>Elasticsearch：擅长海量数据的搜索、分析、计算</p>
</blockquote>
<p><strong>概念对比</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/8e9018fc46f54dc4b38384c48568ba2f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/8e9018fc46f54dc4b38384c48568ba2f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/8e9018fc46f54dc4b38384c48568ba2f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/8e9018fc46f54dc4b38384c48568ba2f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/8e9018fc46f54dc4b38384c48568ba2f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<h2 id="二docker部署es和kibana">二.docker部署es和kibana</h2>
<blockquote>
<p>kibana可以给我们提供一个elasticsearch的可视化界面，便于学习</p>
</blockquote>
<p><strong>1.创建互联网联，让es和kibana容器互联</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker network create es-net
</code></pre></div><p><strong>2.拉取镜像</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">docker</span> <span class="n">pull</span> <span class="n">elasticsearch</span><span class="err">:</span><span class="n">7</span><span class="p">.</span><span class="n">12</span><span class="p">.</span><span class="n">1</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">kibana</span><span class="err">:</span><span class="n">7</span><span class="p">.</span><span class="n">12</span><span class="p">.</span><span class="n">1</span>
</code></pre></div><p><strong>3.部署单点es</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">docker</span> <span class="n">run</span> <span class="n">-d</span> <span class="p">\</span>
	<span class="p">-</span><span class="n">-name</span> <span class="n">es</span> <span class="p">\</span>
    <span class="n">-e</span> <span class="s2">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span> <span class="p">\</span>
    <span class="n">-e</span> <span class="s2">&#34;discovery.type=single-node&#34;</span> <span class="p">\</span>
    <span class="n">-v</span> <span class="nb">es-data</span><span class="err">:</span><span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">elasticsearch</span><span class="p">/</span><span class="n">data</span> <span class="p">\</span>
    <span class="n">-v</span> <span class="nb">es-plugins</span><span class="err">:</span><span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">share</span><span class="p">/</span><span class="n">elasticsearch</span><span class="p">/</span><span class="n">plugins</span> <span class="p">\</span>
    <span class="p">-</span><span class="n">-privileged</span> <span class="p">\</span>
    <span class="p">-</span><span class="n">-network</span> <span class="nb">es-net</span> <span class="p">\</span>
    <span class="n">-p</span> <span class="n">9200</span><span class="err">:</span><span class="n">9200</span> <span class="p">\</span>
    <span class="n">-p</span> <span class="n">9300</span><span class="err">:</span><span class="n">9300</span> <span class="p">\</span>
<span class="n">elasticsearch</span><span class="err">:</span><span class="n">7</span><span class="p">.</span><span class="n">12</span><span class="p">.</span><span class="n">1</span>
</code></pre></div><p>命令解释：</p>
<blockquote>
<ul>
<li><code>-e &quot;cluster.name=es-docker-cluster&quot;</code>：设置集群名称</li>
<li><code>-e &quot;http.host=0.0.0.0&quot;</code>：监听的地址，可以外网访问</li>
<li><code>-e &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</code>：内存大小</li>
<li><code>-e &quot;discovery.type=single-node&quot;</code>：非集群模式</li>
<li><code>-v es-data:/usr/share/elasticsearch/data</code>：挂载逻辑卷，绑定es的数据目录</li>
<li><code>-v es-logs:/usr/share/elasticsearch/logs</code>：挂载逻辑卷，绑定es的日志目录</li>
<li><code>-v es-plugins:/usr/share/elasticsearch/plugins</code>：挂载逻辑卷，绑定es的插件目录</li>
<li><code>--privileged</code>：授予逻辑卷访问权</li>
<li><code>--network es-net</code> ：加入一个名为es-net的网络中</li>
<li><code>-p 9200:9200</code>：端口映射配置</li>
</ul>
</blockquote>
<p>访问9200端口即可看到elasticsearch的响应结果
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/a43050df039d40f79e772714e46e2c42.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/a43050df039d40f79e772714e46e2c42.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/a43050df039d40f79e772714e46e2c42.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/a43050df039d40f79e772714e46e2c42.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/a43050df039d40f79e772714e46e2c42.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p><strong>4.部署kibana</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">docker</span> <span class="n">run</span> <span class="n">-d</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-name</span> <span class="n">kibana</span> <span class="p">\</span>
<span class="n">-e</span> <span class="n">ELASTICSEARCH_HOSTS</span><span class="p">=</span><span class="n">http</span><span class="err">:</span><span class="p">//</span><span class="n">es</span><span class="err">:</span><span class="n">9200</span> <span class="p">\</span>
<span class="p">-</span><span class="n">-network</span><span class="p">=</span><span class="nb">es-net</span> <span class="p">\</span>
<span class="n">-p</span> <span class="n">5601</span><span class="err">:</span><span class="n">5601</span>  <span class="p">\</span>
<span class="n">kibana</span><span class="err">:</span><span class="n">7</span><span class="p">.</span><span class="n">12</span><span class="p">.</span><span class="n">1</span>
</code></pre></div><blockquote>
<ul>
<li><code>--network es-net</code> ：加入一个名为es-net的网络中，与elasticsearch在同一个网络中</li>
<li><code>-e ELASTICSEARCH_HOSTS=http://es:9200&quot;</code>：设置elasticsearch的地址，因为kibana已经与elasticsearch在一个网络，因此可以用容器名直接访问elasticsearch</li>
<li><code>-p 5601:5601</code>：端口映射配置</li>
</ul>
</blockquote>
<p>访问5601端口即可看到kibana的响应结果
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/a23ae8e215704bdda933e1a7cb0745f5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/a23ae8e215704bdda933e1a7cb0745f5.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/a23ae8e215704bdda933e1a7cb0745f5.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/a23ae8e215704bdda933e1a7cb0745f5.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/a23ae8e215704bdda933e1a7cb0745f5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<h2 id="三ik分词器">三.IK分词器</h2>
<p>es在创建倒排索引时需要对文档分词；在搜索时，需要对用户输入内容分词。但默认的分词规则对中文处理并不友好
处理中文分词，一般会使用IK分词器。https://github.com/medcl/elasticsearch-analysis-ik</p>
<p><strong>1.安装IK分词器</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># 进入容器内部</span>
<span class="n">docker</span> <span class="n">exec</span> <span class="n">-it</span> <span class="n">elasticsearch</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span>

<span class="c"># 在线下载并安装</span>
<span class="p">./</span><span class="n">bin</span><span class="p">/</span><span class="nb">elasticsearch-plugin</span>  <span class="n">install</span> <span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">medcl</span><span class="p">/</span><span class="nb">elasticsearch-analysis</span><span class="n">-ik</span><span class="p">/</span><span class="n">releases</span><span class="p">/</span><span class="n">download</span><span class="p">/</span><span class="n">v7</span><span class="p">.</span><span class="n">12</span><span class="p">.</span><span class="n">1</span><span class="p">/</span><span class="nb">elasticsearch-analysis</span><span class="n">-ik</span><span class="p">-</span><span class="n">7</span><span class="p">.</span><span class="n">12</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">zip</span>

<span class="c">#退出</span>
<span class="n">exit</span>
<span class="c">#重启容器</span>
<span class="n">docker</span> <span class="n">restart</span> <span class="n">elasticsearch</span>
</code></pre></div><p><strong>2.IK分词器包含两种模式</strong>：</p>
<ul>
<li>
<p><code>ik_smart</code>：智能切分 最少切分 粗粒度 分出的词较少</p>
</li>
<li>
<p><code>ik_max_word</code>：最细切分 细粒度 分出的词较多 内存消耗高</p>
</li>
</ul>
<p><strong>3.拓展词库</strong>
要拓展ik分词器的词库，只需要修改一个ik分词器目录中的config目录中的IkAnalyzer.cfg.xml文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="cp">&lt;!DOCTYPE properties SYSTEM &#34;http://java.sun.com/dtd/properties.dtd&#34;&gt;</span>
<span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;comment&gt;</span>IK Analyzer 扩展配置<span class="nt">&lt;/comment&gt;</span>
        <span class="c">&lt;!--用户可以在这里配置自己的扩展字典 *** 添加扩展词典--&gt;</span>
        <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&#34;ext_dict&#34;</span><span class="nt">&gt;</span>ext.dic<span class="nt">&lt;/entry&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
</code></pre></div><p>然后在名为ext.dic的文件中，添加想要拓展的词语即可</p>
<p><strong>4.停用词库</strong>
要禁用某些敏感词条，只需要修改一个ik分词器目录中的config目录中的IkAnalyzer.cfg.xml文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="cp">&lt;!DOCTYPE properties SYSTEM &#34;http://java.sun.com/dtd/properties.dtd&#34;&gt;</span>
<span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;comment&gt;</span>IK Analyzer 扩展配置<span class="nt">&lt;/comment&gt;</span>
        <span class="c">&lt;!--用户可以在这里配置自己的扩展字典--&gt;</span>
        <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&#34;ext_dict&#34;</span><span class="nt">&gt;</span>ext.dic<span class="nt">&lt;/entry&gt;</span>
         <span class="c">&lt;!--用户可以在这里配置自己的扩展停止词字典  *** 添加停用词词典--&gt;</span>
        <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&#34;ext_stopwords&#34;</span><span class="nt">&gt;</span>stopword.dic<span class="nt">&lt;/entry&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
</code></pre></div><p>然后在名为stopword.dic的文件中，添加想要拓展的词语即可</p>
<h2 id="四dsl及dev-tools">四.DSL及Dev Tools</h2>
<blockquote>
<p>官网学习地址：https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</p>
</blockquote>
<p>DSL是elasticsearch提供的JSON风格的请求语句，用来操作elasticsearch，实现CRUD</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">GET</span> <span class="err">/</span>  <span class="err">相当于直接访问</span><span class="mi">9200</span><span class="err">端口</span>
</code></pre></div><p>Dev Tools是kibana提供的一种可视化工具</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/58e0828f72d1472580e33de68989ebd6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/58e0828f72d1472580e33de68989ebd6.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/58e0828f72d1472580e33de68989ebd6.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/58e0828f72d1472580e33de68989ebd6.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/58e0828f72d1472580e33de68989ebd6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<h2 id="五索引库操作">五.索引库操作</h2>
<p><strong>1.mapping属性</strong></p>
<p>映射是定义文档及其包含的字段如何存储和索引的过程。<br>
每个文档都是字段的集合，每个字段都有自己的数据类型。 在映射数据时，创建一个映射定义，该定义包含与文档相关的字段列表。 映射定义还包括元数据字段，比如_source字段，它自定义如何处理文档的相关元数据。<br>
mapping是对索引库中文档的约束，常见的mapping属性包括：</p>
<ul>
<li>type：字段数据类型，常见的简单类型有：
<ul>
<li>字符串：text（可分词的文本）、keyword（精确值，例如：品牌、国家、ip地址）</li>
<li>数值：long、integer、short、byte、double、float、</li>
<li>布尔：boolean</li>
<li>日期：date</li>
<li>对象：object</li>
</ul>
</li>
<li>index：是否创建索引，默认为true</li>
<li>analyzer：使用哪种分词器</li>
<li>properties：该字段的子字段</li>
</ul>
<p><strong>2.创建索引库</strong></p>
<p>ES中通过Restful请求操作索引库、文档。请求内容用DSL语句来表示。创建索引库和mapping的DSL语法如下：
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/c494a175488545a5bfa42812e9d34e4a.png"
        data-srcset="https://img-blog.csdnimg.cn/c494a175488545a5bfa42812e9d34e4a.png, https://img-blog.csdnimg.cn/c494a175488545a5bfa42812e9d34e4a.png 1.5x, https://img-blog.csdnimg.cn/c494a175488545a5bfa42812e9d34e4a.png 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/c494a175488545a5bfa42812e9d34e4a.png"
        title="在这里插入图片描述" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/5180e2d60568446298ebf9593325965c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/5180e2d60568446298ebf9593325965c.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/5180e2d60568446298ebf9593325965c.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/5180e2d60568446298ebf9593325965c.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/5180e2d60568446298ebf9593325965c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<strong>3.查询索引库</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml">GET /索引库名
</code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/0fad02dcd681487dbad399384873a81c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/0fad02dcd681487dbad399384873a81c.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/0fad02dcd681487dbad399384873a81c.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/0fad02dcd681487dbad399384873a81c.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/0fad02dcd681487dbad399384873a81c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p><strong>4.删除索引库</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml">DELETE /索引库名
</code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/9182362b0494445dbf44ab2c05ffbf07.png"
        data-srcset="https://img-blog.csdnimg.cn/9182362b0494445dbf44ab2c05ffbf07.png, https://img-blog.csdnimg.cn/9182362b0494445dbf44ab2c05ffbf07.png 1.5x, https://img-blog.csdnimg.cn/9182362b0494445dbf44ab2c05ffbf07.png 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/9182362b0494445dbf44ab2c05ffbf07.png"
        title="在这里插入图片描述" /></p>
<p><strong>5.修改索引库</strong></p>
<p>索引库和mapping一旦创建无法修改，但是可以添加新的字段，语法如下：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/9ac68904d44e4fa98e63a762469563ef.png"
        data-srcset="https://img-blog.csdnimg.cn/9ac68904d44e4fa98e63a762469563ef.png, https://img-blog.csdnimg.cn/9ac68904d44e4fa98e63a762469563ef.png 1.5x, https://img-blog.csdnimg.cn/9ac68904d44e4fa98e63a762469563ef.png 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/9ac68904d44e4fa98e63a762469563ef.png"
        title="在这里插入图片描述" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/07ae5e269abc42f3b7c07e624a86ca68.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/07ae5e269abc42f3b7c07e624a86ca68.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/07ae5e269abc42f3b7c07e624a86ca68.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/07ae5e269abc42f3b7c07e624a86ca68.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/07ae5e269abc42f3b7c07e624a86ca68.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<h2 id="五文档操作">五.文档操作</h2>
<p><strong>1.添加文档</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/3d66c920ccde42969c6ec62a0b366b45.png"
        data-srcset="https://img-blog.csdnimg.cn/3d66c920ccde42969c6ec62a0b366b45.png, https://img-blog.csdnimg.cn/3d66c920ccde42969c6ec62a0b366b45.png 1.5x, https://img-blog.csdnimg.cn/3d66c920ccde42969c6ec62a0b366b45.png 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/3d66c920ccde42969c6ec62a0b366b45.png"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/82916308d5d64c0cb133a0df4b5b78d3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/82916308d5d64c0cb133a0df4b5b78d3.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/82916308d5d64c0cb133a0df4b5b78d3.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/82916308d5d64c0cb133a0df4b5b78d3.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/82916308d5d64c0cb133a0df4b5b78d3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /><strong>2.查询文档</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml">GET /索引库名/_doc/文档id
</code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/fd049d4a0f50428883f7f55d438f8f3a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/fd049d4a0f50428883f7f55d438f8f3a.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/fd049d4a0f50428883f7f55d438f8f3a.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/fd049d4a0f50428883f7f55d438f8f3a.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/fd049d4a0f50428883f7f55d438f8f3a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p><strong>3.删除文档</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml">DELETE /索引库名/_doc/文档id
</code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/4d8c28f16f87464fbdc86b8f0d2ba7ec.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/4d8c28f16f87464fbdc86b8f0d2ba7ec.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/4d8c28f16f87464fbdc86b8f0d2ba7ec.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/4d8c28f16f87464fbdc86b8f0d2ba7ec.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/4d8c28f16f87464fbdc86b8f0d2ba7ec.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p><strong>4.修改文档</strong></p>
<ul>
<li>方式一：全量修改，会删除旧文档，添加新文档</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/d99666d552434dfdafa87b401149bc2e.png"
        data-srcset="https://img-blog.csdnimg.cn/d99666d552434dfdafa87b401149bc2e.png, https://img-blog.csdnimg.cn/d99666d552434dfdafa87b401149bc2e.png 1.5x, https://img-blog.csdnimg.cn/d99666d552434dfdafa87b401149bc2e.png 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/d99666d552434dfdafa87b401149bc2e.png"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/1fe5e1a6668948d8907c9a9f1299d3e2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/1fe5e1a6668948d8907c9a9f1299d3e2.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/1fe5e1a6668948d8907c9a9f1299d3e2.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/1fe5e1a6668948d8907c9a9f1299d3e2.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/1fe5e1a6668948d8907c9a9f1299d3e2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<ul>
<li>方式二：增量修改，修改指定字段值</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/a49cf74c9c6a4206ae78e8cac1f7bf3b.png"
        data-srcset="https://img-blog.csdnimg.cn/a49cf74c9c6a4206ae78e8cac1f7bf3b.png, https://img-blog.csdnimg.cn/a49cf74c9c6a4206ae78e8cac1f7bf3b.png 1.5x, https://img-blog.csdnimg.cn/a49cf74c9c6a4206ae78e8cac1f7bf3b.png 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/a49cf74c9c6a4206ae78e8cac1f7bf3b.png"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/26da7bbd83d7449e801a15e694129520.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/26da7bbd83d7449e801a15e694129520.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/26da7bbd83d7449e801a15e694129520.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/26da7bbd83d7449e801a15e694129520.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/26da7bbd83d7449e801a15e694129520.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<h2 id="六restclient操作索引库">六.RestClient操作索引库</h2>
<p>ES官方提供了各种不同语言的客户端，用来操作ES。这些客户端的本质就是组装DSL语句，通过http请求发送给ES</p>
<p>官方文档地址：https://www.elastic.co/guide/en/elasticsearch/client/index.html</p>
<p><strong>1.初始化RestClient</strong>
指定版本，需要与es版本一致</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;properties&gt;</span>
     <span class="nt">&lt;java.version&gt;</span>1.8<span class="nt">&lt;/java.version&gt;</span>
     <span class="nt">&lt;elasticsearch.version&gt;</span>7.12.1<span class="nt">&lt;/elasticsearch.version&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
</code></pre></div><p>导入包</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
     <span class="nt">&lt;groupId&gt;</span>org.elasticsearch.client<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>elasticsearch-rest-high-level-client<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><p>初始化RestClient</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">RestHighLevelClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RestHighLevelClient</span><span class="o">(</span><span class="n">RestClient</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span>
	<span class="n">HttpHost</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&#34;http://101.43.16.42:9200&#34;</span><span class="o">)</span>
<span class="o">));;</span>
</code></pre></div><p><strong>2.创建索引库</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">createHotelIndex</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">CreateIndexRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CreateIndexRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">);</span>
    <span class="c1">// 2.准备请求参数；DSL语句
</span><span class="c1"></span>    <span class="c1">//MAPPING_TEMPLATE是静态常量字符串，内容是创建索引库的DSL语句
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">MAPPING_TEMPLATE</span><span class="o">,</span> <span class="n">XContentType</span><span class="o">.</span><span class="na">JSON</span><span class="o">);</span>
    <span class="c1">// 3.发送请求
</span><span class="c1"></span>    <span class="n">client</span><span class="o">.</span><span class="na">indices</span><span class="o">().</span><span class="na">create</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><strong>3.删除索引库</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testDeleteHotelIndex</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">DeleteIndexRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DeleteIndexRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">);</span>
    <span class="c1">// 2.发送请求
</span><span class="c1"></span>    <span class="n">client</span><span class="o">.</span><span class="na">indices</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><strong>4.判断索引库是否存在</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testExitHotelIndex</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">GetIndexRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetIndexRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">);</span>
    <span class="c1">// 2.发送请求
</span><span class="c1"></span>    <span class="kt">boolean</span> <span class="n">exists</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">indices</span><span class="o">().</span><span class="na">exists</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
    <span class="c1">//3.输出结果
</span><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">exists</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h2 id="七restclient操作文档">七.RestClient操作文档</h2>
<p><strong>1.新增文档</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"> <span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testAddDocument</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">//根据id查询酒店数据
</span><span class="c1"></span>    <span class="n">Hotel</span> <span class="n">hotel</span> <span class="o">=</span> <span class="n">hotelService</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">61083L</span><span class="o">);</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">IndexRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IndexRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="n">hotel</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
    <span class="c1">// 2.准备请求参数；DSL语句
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">hotel</span><span class="o">),</span><span class="n">XContentType</span><span class="o">.</span><span class="na">JSON</span><span class="o">);</span>
    <span class="c1">// 3.发送请求
</span><span class="c1"></span>    <span class="n">client</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><strong>2.查询文档</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testGetDocumentById</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">GetRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">,</span> <span class="s">&#34;61083&#34;</span><span class="o">);</span>
    <span class="c1">// 2.发送请求
</span><span class="c1"></span>    <span class="n">GetResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
    <span class="c1">// 3.解析响应结果
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getSourceAsString</span><span class="o">();</span>
    <span class="c1">//反序列化
</span><span class="c1"></span>    <span class="n">HotelDoc</span> <span class="n">hotelDoc</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">HotelDoc</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hotelDoc</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><strong>3.更新文档</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testUpdateDocument</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.准备request
</span><span class="c1"></span>    <span class="n">UpdateRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UpdateRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">,</span> <span class="s">&#34;61083&#34;</span><span class="o">);</span>
    <span class="c1">// 2.准备请求参数
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">doc</span><span class="o">(</span>
            <span class="s">&#34;price&#34;</span><span class="o">,</span><span class="s">&#34;952&#34;</span><span class="o">,</span>
            <span class="s">&#34;starName&#34;</span><span class="o">,</span><span class="s">&#34;四钻&#34;</span>
    <span class="o">);</span>
    <span class="c1">// 3.发送请求
</span><span class="c1"></span>    <span class="n">client</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><strong>4.删除文档</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testDeleteDocument</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.准备request
</span><span class="c1"></span>    <span class="n">DeleteRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DeleteRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">,</span> <span class="s">&#34;61083&#34;</span><span class="o">);</span>
    <span class="c1">// 2.发送请求
</span><span class="c1"></span>    <span class="n">client</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><strong>5.批量新增文档</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testBulkDocument</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">//批量查询酒店数据
</span><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">Hotel</span><span class="o">&gt;</span> <span class="n">hotels</span> <span class="o">=</span> <span class="n">hotelService</span><span class="o">.</span><span class="na">list</span><span class="o">();</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">BulkRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BulkRequest</span><span class="o">();</span>
    <span class="c1">// 2.准备请求参数，添加多个新增的Request
</span><span class="c1"></span>    <span class="k">for</span><span class="o">(</span><span class="n">Hotel</span> <span class="n">hotel</span><span class="o">:</span><span class="n">hotels</span><span class="o">){</span>
        <span class="c1">// 转换为HotelDoc
</span><span class="c1"></span>        <span class="n">HotelDoc</span> <span class="n">hotelDoc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HotelDoc</span><span class="o">(</span><span class="n">hotel</span><span class="o">);</span>
        <span class="n">request</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">IndexRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">hotel</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">())</span>
                <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">hotelDoc</span><span class="o">),</span><span class="n">XContentType</span><span class="o">.</span><span class="na">JSON</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">// 3.发送请求
</span><span class="c1"></span>    <span class="n">client</span><span class="o">.</span><span class="na">bulk</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><h2 id="八dsl查询语法">八.DSL查询语法</h2>
<blockquote>
<p>Elasticsearch提供了基于JSON的DSL（Domain Specific  Language）来定义查询。
官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html</p>
</blockquote>
<p>常见的查询类型包括：</p>
<ul>
<li>查询所有：查询出所有数据，一般测试用。例如：
<ul>
<li>match_all</li>
</ul>
</li>
<li>全文检索（full text）查询：利用分词器对用户输入内容分词，然后去倒排索引库中匹配。例如：
<ul>
<li>match_query</li>
<li>multi_match_query</li>
</ul>
</li>
<li>精确查询：根据精确词条值查找数据，一般是查找keyword、数值、日期、boolean等类型字段。例如：
<ul>
<li>ids</li>
<li>range</li>
<li>term</li>
</ul>
</li>
<li>地理（geo）查询：根据经纬度查询。例如：
<ul>
<li>geo_distance</li>
<li>geo_bounding_box</li>
</ul>
</li>
<li>复合（compound）查询：复合查询可以将上述各种查询条件组合起来，合并查询条件。例如：
<ul>
<li>bool</li>
<li>function_score</li>
</ul>
</li>
</ul>
<p>查询的语法基本一致：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/62c010a66de94f628d48f19e1d80b662.png"
        data-srcset="https://img-blog.csdnimg.cn/62c010a66de94f628d48f19e1d80b662.png, https://img-blog.csdnimg.cn/62c010a66de94f628d48f19e1d80b662.png 1.5x, https://img-blog.csdnimg.cn/62c010a66de94f628d48f19e1d80b662.png 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/62c010a66de94f628d48f19e1d80b662.png"
        title="在这里插入图片描述" /></p>
<ul>
<li>查询类型为match_all</li>
<li>没有查询条件
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/b0355bab574f43299a4bf7305dd7bea8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/b0355bab574f43299a4bf7305dd7bea8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/b0355bab574f43299a4bf7305dd7bea8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/b0355bab574f43299a4bf7305dd7bea8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/b0355bab574f43299a4bf7305dd7bea8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></li>
</ul>
<p><strong>1.全文检索</strong></p>
<p>全文检索查询，会对输入框输入内容分词，常用于搜索框搜索</p>
<p>①match查询：单字段查询
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/86e40aea563245aea6633bfcac8f2753.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/86e40aea563245aea6633bfcac8f2753.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/86e40aea563245aea6633bfcac8f2753.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/86e40aea563245aea6633bfcac8f2753.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/86e40aea563245aea6633bfcac8f2753.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p>②multi_match查询：多字段查询，任意一个字段符合条件就算符合查询条件</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/2f7aad5da08b4635b188578222ce23b1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/2f7aad5da08b4635b188578222ce23b1.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/2f7aad5da08b4635b188578222ce23b1.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/2f7aad5da08b4635b188578222ce23b1.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/2f7aad5da08b4635b188578222ce23b1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<blockquote>
<p>ps：multi_match根据多个字段查询，参与查询字段越多，查询性能越差，使用copy_to将多字段拷贝到一个字段中可以提升性能</p>
</blockquote>
<p><strong>2.精确查询</strong></p>
<p>精确查询一般是查找keyword、数值、日期、boolean等类型字段。所以<strong>不会</strong>对搜索条件分词</p>
<p>①term：根据词条精确值查询</p>
<blockquote>
<p>因为精确查询的字段搜是不分词的字段，因此查询的条件也必须是不分词的词条。查询时，用户输入的内容跟自动值完全匹配时才认为符合条件。如果用户输入的内容过多，反而搜索不到数据</p>
</blockquote>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/385611676ddd45cf9244295556cdd477.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/385611676ddd45cf9244295556cdd477.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/385611676ddd45cf9244295556cdd477.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/385611676ddd45cf9244295556cdd477.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/385611676ddd45cf9244295556cdd477.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p>②range：根据值的范围查询</p>
<blockquote>
<p>gte代表大于等于，gt则代表大于
lte代表小于等于，lt则代表小于</p>
</blockquote>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/bc393174346c416992c688e79decd9b1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/bc393174346c416992c688e79decd9b1.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/bc393174346c416992c688e79decd9b1.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/bc393174346c416992c688e79decd9b1.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/bc393174346c416992c688e79decd9b1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<strong>3.地理查询</strong></p>
<p>①geo_distance
附近查询，也叫做距离查询（geo_distance）：查询到指定中心点小于某个距离值的所有文档
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/0901f881e3564ed5b2e0faad6d510dde.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/0901f881e3564ed5b2e0faad6d510dde.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/0901f881e3564ed5b2e0faad6d510dde.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/0901f881e3564ed5b2e0faad6d510dde.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/0901f881e3564ed5b2e0faad6d510dde.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p>②geo_bounding_box
矩形范围查询，也就是geo_bounding_box查询，查询坐标落在某个矩形范围的所有文档
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/f2e78c1b45ce47c787dc0f5b8773ce06.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_11,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/f2e78c1b45ce47c787dc0f5b8773ce06.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_11%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/f2e78c1b45ce47c787dc0f5b8773ce06.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_11%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/f2e78c1b45ce47c787dc0f5b8773ce06.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_11%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/f2e78c1b45ce47c787dc0f5b8773ce06.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_11,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p><strong>4.复合查询</strong></p>
<p>复合（compound）查询：复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑。常见的有两种：</p>
<ul>
<li>fuction score：算分函数查询，可以控制文档相关性算分，控制文档排名</li>
<li>bool query：布尔查询，利用逻辑关系组合多个其它的查询，实现复杂搜索</li>
</ul>
<p><strong>相关性算法</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/fd1141bfc98f4dd69725589b4da972a0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/fd1141bfc98f4dd69725589b4da972a0.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/fd1141bfc98f4dd69725589b4da972a0.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/fd1141bfc98f4dd69725589b4da972a0.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/fd1141bfc98f4dd69725589b4da972a0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p><strong>TF对比BM25</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/00ab812f05824fa4b3555fd5051ee38e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/00ab812f05824fa4b3555fd5051ee38e.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/00ab812f05824fa4b3555fd5051ee38e.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/00ab812f05824fa4b3555fd5051ee38e.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/00ab812f05824fa4b3555fd5051ee38e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />①fuction score</p>
<p>function score query定义的三要素</p>
<ul>
<li>过滤条件：哪些文档要加分</li>
<li>算分函数：如何计算function score</li>
<li>加权方式：function score 与 query score如何运算<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/7341f4e2d44a40c7b8a517b03766270d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/7341f4e2d44a40c7b8a517b03766270d.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/7341f4e2d44a40c7b8a517b03766270d.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/7341f4e2d44a40c7b8a517b03766270d.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/7341f4e2d44a40c7b8a517b03766270d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/b0d2c42d0e624b43a10e6bc132cb2bd8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/b0d2c42d0e624b43a10e6bc132cb2bd8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/b0d2c42d0e624b43a10e6bc132cb2bd8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/b0d2c42d0e624b43a10e6bc132cb2bd8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/b0d2c42d0e624b43a10e6bc132cb2bd8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></li>
</ul>
<p>②bool query</p>
<p>布尔查询是一个或多个查询子句的组合，每一个子句就是一个子查询。子查询的组合方式有：</p>
<ul>
<li>must：必须匹配每个子查询，类似“与”</li>
<li>should：选择性匹配子查询，类似“或”</li>
<li>must_not：必须不匹配，不参与算分，类似“非”</li>
<li>filter：必须匹配，不参与算分</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/0e5eb2ba81b144e6b1723c2e45446ae0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/0e5eb2ba81b144e6b1723c2e45446ae0.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/0e5eb2ba81b144e6b1723c2e45446ae0.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/0e5eb2ba81b144e6b1723c2e45446ae0.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/0e5eb2ba81b144e6b1723c2e45446ae0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<blockquote>
<p>需要注意的是，搜索时，参与打分的字段越多，查询的性能也越差。因此这种多条件查询时，一遍这样做：</p>
<ul>
<li>搜索框的关键字搜索，是全文检索查询，使用must查询，参与算分</li>
<li>其它过滤条件，采用filter查询。不参与算分</li>
</ul>
</blockquote>
<h2 id="九搜索结果处理">九.搜索结果处理</h2>
<p>elasticsearch默认是根据相关度算分（_score）来排序，但是也支持自定义方式对搜索结果排序。可以排序字段类型有：keyword类型、数值类型、地理坐标类型、日期类型等。</p>
<p>官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html</p>
<p><strong>1.排序</strong></p>
<p>①常规字段排序</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/69deca557c964f9c852339aa53311fed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_16,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/69deca557c964f9c852339aa53311fed.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_16%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/69deca557c964f9c852339aa53311fed.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_16%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/69deca557c964f9c852339aa53311fed.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_16%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/69deca557c964f9c852339aa53311fed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_16,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/3aa5768b81844066ab9f36b69a286491.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/3aa5768b81844066ab9f36b69a286491.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/3aa5768b81844066ab9f36b69a286491.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/3aa5768b81844066ab9f36b69a286491.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/3aa5768b81844066ab9f36b69a286491.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
②地理位置排序</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/d43ca7f601bd48d5a2bf5d43b15e9cc8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_9,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/d43ca7f601bd48d5a2bf5d43b15e9cc8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_9%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/d43ca7f601bd48d5a2bf5d43b15e9cc8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_9%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/d43ca7f601bd48d5a2bf5d43b15e9cc8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_9%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/d43ca7f601bd48d5a2bf5d43b15e9cc8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_9,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/943bca2ef37a45c181d3a3acf198abe5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/943bca2ef37a45c181d3a3acf198abe5.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/943bca2ef37a45c181d3a3acf198abe5.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/943bca2ef37a45c181d3a3acf198abe5.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/943bca2ef37a45c181d3a3acf198abe5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<strong>2.分页</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/d14b7d74e6bd48ceaea6493f270dce46.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/d14b7d74e6bd48ceaea6493f270dce46.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/d14b7d74e6bd48ceaea6493f270dce46.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/d14b7d74e6bd48ceaea6493f270dce46.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/d14b7d74e6bd48ceaea6493f270dce46.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p><strong>深度分页问题</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/2d704c2cbca545ccb8c177a60dda34f2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/2d704c2cbca545ccb8c177a60dda34f2.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/2d704c2cbca545ccb8c177a60dda34f2.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/2d704c2cbca545ccb8c177a60dda34f2.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/2d704c2cbca545ccb8c177a60dda34f2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/0e1ee62578284cb9ac5e43288fed83c8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/0e1ee62578284cb9ac5e43288fed83c8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/0e1ee62578284cb9ac5e43288fed83c8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/0e1ee62578284cb9ac5e43288fed83c8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/0e1ee62578284cb9ac5e43288fed83c8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<strong>解决深度分页问题</strong></p>
<p>官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html</p>
<ul>
<li>search after：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。</li>
<li>scroll：原理将排序后的文档id形成快照，保存在内存。官方已经不推荐使用。</li>
</ul>
<p><strong>分页查询的常见实现方案以及优缺点</strong></p>
<ul>
<li>
<p><code>from + size</code>：</p>
<ul>
<li>优点：支持随机翻页</li>
<li>缺点：深度分页问题，默认查询上限（from + size）是10000</li>
<li>场景：百度、京东、谷歌、淘宝这样的随机翻页搜索</li>
</ul>
</li>
<li>
<p><code>after search</code>：</p>
<ul>
<li>优点：没有查询上限（单次查询的size不超过10000）</li>
<li>缺点：只能向后逐页查询，不支持随机翻页</li>
<li>场景：没有随机翻页需求的搜索，例如手机向下滚动翻页</li>
</ul>
</li>
<li>
<p><code>scroll</code>：</p>
<ul>
<li>优点：没有查询上限（单次查询的size不超过10000）</li>
<li>缺点：会有额外内存消耗，并且搜索结果是非实时的</li>
<li>场景：海量数据的获取和迁移。从ES7.1开始不推荐，建议用 after search方案。</li>
</ul>
</li>
</ul>
<p><strong>3.高亮</strong></p>
<p>高亮显示的实现分为两步：
给文档中的所有关键字都添加一个标签，例如<!-- raw HTML omitted -->标签
页面给<!-- raw HTML omitted -->标签编写CSS样式</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/3801c8a9b4954d11839a294de520a30a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_13,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/3801c8a9b4954d11839a294de520a30a.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_13%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/3801c8a9b4954d11839a294de520a30a.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_13%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/3801c8a9b4954d11839a294de520a30a.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_13%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/3801c8a9b4954d11839a294de520a30a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_13,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/779db707f92345cf92133601274383aa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/779db707f92345cf92133601274383aa.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/779db707f92345cf92133601274383aa.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/779db707f92345cf92133601274383aa.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/779db707f92345cf92133601274383aa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<h2 id="十restclient查询文档">十.RestClient查询文档</h2>
<blockquote>
<p>查询的基本步骤是：</p>
<ol>
<li>
<p>创建SearchRequest对象</p>
</li>
<li>
<p>准备Request.source()，也就是DSL。</p>
<p>① QueryBuilders来构建查询条件</p>
<p>② 传入Request.source() 的 query() 方法</p>
</li>
<li>
<p>发送请求，得到结果</p>
</li>
<li>
<p>解析结果（参考JSON结果，从外到内，逐层解析）</p>
</li>
</ol>
</blockquote>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/29c4ca567ac8476f91af9ebeb09b37a7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/29c4ca567ac8476f91af9ebeb09b37a7.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/29c4ca567ac8476f91af9ebeb09b37a7.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/29c4ca567ac8476f91af9ebeb09b37a7.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/29c4ca567ac8476f91af9ebeb09b37a7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/b1f6bbf46565416c888a47a6de558d16.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/b1f6bbf46565416c888a47a6de558d16.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/b1f6bbf46565416c888a47a6de558d16.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/b1f6bbf46565416c888a47a6de558d16.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/b1f6bbf46565416c888a47a6de558d16.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
elasticsearch返回的结果是一个JSON字符串，结构包含：</p>
<ul>
<li><code>hits</code>：命中的结果
<ul>
<li><code>total</code>：总条数，其中的value是具体的总条数值</li>
<li><code>max_score</code>：所有结果中得分最高的文档的相关性算分</li>
<li><code>hits</code>：搜索结果的文档数组，其中的每个文档都是一个json对象
<ul>
<li><code>_source</code>：文档中的原始数据，也是json对象</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>因此，解析响应结果，就是逐层解析JSON字符串，流程如下：</p>
<ul>
<li><code>SearchHits</code>：通过response.getHits()获取，就是JSON中的最外层的hits，代表命中的结果
<ul>
<li><code>SearchHits#getTotalHits().value</code>：获取总条数信息</li>
<li><code>SearchHits#getHits()</code>：获取SearchHit数组，也就是文档数组
<ul>
<li><code>SearchHit#getSourceAsString()</code>：获取文档结果中的_source，也就是原始的json文档数据</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>完整代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testMatchAll</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">SearchRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SearchRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">);</span>
    <span class="c1">// 2.准备请求参数；DSL语句
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">query</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchAllQuery</span><span class="o">());</span>
    <span class="c1">// 3.发送请求
</span><span class="c1"></span>    <span class="n">SearchResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>

    <span class="c1">// 4.解析响应
</span><span class="c1"></span>    <span class="n">SearchHits</span> <span class="n">searchHits</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getHits</span><span class="o">();</span>
    <span class="c1">// 4.1.获得总条数
</span><span class="c1"></span>    <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">().</span><span class="na">value</span><span class="o">;</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">total</span><span class="o">);</span>
    <span class="c1">// 4.1.文档数组
</span><span class="c1"></span>    <span class="n">SearchHit</span><span class="o">[]</span> <span class="n">hits</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getHits</span><span class="o">();</span>
    <span class="c1">// 4.3.遍历
</span><span class="c1"></span>    <span class="k">for</span><span class="o">(</span><span class="n">SearchHit</span> <span class="n">hit</span> <span class="o">:</span> <span class="n">hits</span><span class="o">){</span>
        <span class="c1">// 获取文档source
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsString</span><span class="o">();</span>
        <span class="c1">// 反序列化
</span><span class="c1"></span>        <span class="n">HotelDoc</span> <span class="n">hotelDoc</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">HotelDoc</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hotelDoc</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>1.全文检索查询</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/82373657445444f99b2b7efbe6efbeed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/82373657445444f99b2b7efbe6efbeed.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/82373657445444f99b2b7efbe6efbeed.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/82373657445444f99b2b7efbe6efbeed.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/82373657445444f99b2b7efbe6efbeed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testMatch</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">SearchRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SearchRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">);</span>
    <span class="c1">// 2.准备请求参数；DSL语句
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">()</span>
            <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchQuery</span><span class="o">(</span><span class="s">&#34;all&#34;</span><span class="o">,</span> <span class="s">&#34;如家&#34;</span><span class="o">));</span>
    <span class="c1">// 3.发送请求
</span><span class="c1"></span>    <span class="n">SearchResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>

    <span class="c1">// 4.解析响应
</span><span class="c1"></span>    <span class="n">SearchHits</span> <span class="n">searchHits</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getHits</span><span class="o">();</span>
    <span class="c1">// 4.1.获得总条数
</span><span class="c1"></span>    <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">().</span><span class="na">value</span><span class="o">;</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">total</span><span class="o">);</span>
    <span class="c1">// 4.1.文档数组
</span><span class="c1"></span>    <span class="n">SearchHit</span><span class="o">[]</span> <span class="n">hits</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getHits</span><span class="o">();</span>
    <span class="c1">// 4.3.遍历
</span><span class="c1"></span>    <span class="k">for</span><span class="o">(</span><span class="n">SearchHit</span> <span class="n">hit</span> <span class="o">:</span> <span class="n">hits</span><span class="o">){</span>
        <span class="c1">// 获取文档source
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsString</span><span class="o">();</span>
        <span class="c1">// 反序列化
</span><span class="c1"></span>        <span class="n">HotelDoc</span> <span class="n">hotelDoc</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">HotelDoc</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hotelDoc</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Ctrl+Alt+M可以抽取重复代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleResponse</span><span class="o">(</span><span class="n">SearchResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 4.解析响应
</span><span class="c1"></span>    <span class="n">SearchHits</span> <span class="n">searchHits</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getHits</span><span class="o">();</span>
    <span class="c1">// 4.1.获得总条数
</span><span class="c1"></span>    <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">().</span><span class="na">value</span><span class="o">;</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">total</span><span class="o">);</span>
    <span class="c1">// 4.1.文档数组
</span><span class="c1"></span>    <span class="n">SearchHit</span><span class="o">[]</span> <span class="n">hits</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getHits</span><span class="o">();</span>
    <span class="c1">// 4.3.遍历
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">SearchHit</span> <span class="n">hit</span> <span class="o">:</span> <span class="n">hits</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 获取文档source
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsString</span><span class="o">();</span>
        <span class="c1">// 反序列化
</span><span class="c1"></span>        <span class="n">HotelDoc</span> <span class="n">hotelDoc</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">HotelDoc</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hotelDoc</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>2.精确查询</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/9385f6a9e8ea46569680deafc8f62ad7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/9385f6a9e8ea46569680deafc8f62ad7.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/9385f6a9e8ea46569680deafc8f62ad7.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/9385f6a9e8ea46569680deafc8f62ad7.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/9385f6a9e8ea46569680deafc8f62ad7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<strong>3.复合查询</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/07993a34fb144eb68d6cfcdcd633a1fa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/07993a34fb144eb68d6cfcdcd633a1fa.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/07993a34fb144eb68d6cfcdcd633a1fa.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/07993a34fb144eb68d6cfcdcd633a1fa.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/07993a34fb144eb68d6cfcdcd633a1fa.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/804b48c9658b4604aa5e7239c43cb2d7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/804b48c9658b4604aa5e7239c43cb2d7.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/804b48c9658b4604aa5e7239c43cb2d7.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/804b48c9658b4604aa5e7239c43cb2d7.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/804b48c9658b4604aa5e7239c43cb2d7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testBool</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">SearchRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SearchRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">);</span>
    <span class="c1">// 2.准备请求参数；DSL语句
</span><span class="c1"></span>    <span class="c1">// 2.1.准备BooleanQuery
</span><span class="c1"></span>    <span class="n">BoolQueryBuilder</span> <span class="n">boolQuery</span> <span class="o">=</span> <span class="n">QueryBuilders</span><span class="o">.</span><span class="na">boolQuery</span><span class="o">();</span>
    <span class="c1">// 2.2.添加term
</span><span class="c1"></span>    <span class="n">boolQuery</span><span class="o">.</span><span class="na">must</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">termQuery</span><span class="o">(</span><span class="s">&#34;city&#34;</span><span class="o">,</span><span class="s">&#34;上海&#34;</span><span class="o">));</span>
    <span class="c1">// 2.3.添加range
</span><span class="c1"></span>    <span class="n">boolQuery</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">rangeQuery</span><span class="o">(</span><span class="s">&#34;price&#34;</span><span class="o">).</span><span class="na">gte</span><span class="o">(</span><span class="n">100</span><span class="o">));</span>
    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">query</span><span class="o">(</span><span class="n">boolQuery</span><span class="o">);</span>
    <span class="c1">// 3.发送请求
</span><span class="c1"></span>    <span class="n">SearchResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
    <span class="n">handleResponse</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p><strong>4.排序和分页</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/20a589166cfd407b8f8bb755b61b3202.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/20a589166cfd407b8f8bb755b61b3202.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/20a589166cfd407b8f8bb755b61b3202.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/20a589166cfd407b8f8bb755b61b3202.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/20a589166cfd407b8f8bb755b61b3202.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testPageAndSort</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 页码，每页大小
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">page</span> <span class="o">=</span> <span class="n">2</span><span class="o">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">5</span><span class="o">;</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">SearchRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SearchRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">);</span>
    <span class="c1">// 2.准备请求参数；DSL语句
</span><span class="c1"></span>    <span class="c1">// 2.1.query
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">query</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchAllQuery</span><span class="o">());</span>
    <span class="c1">// 2.2.sort
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">sort</span><span class="o">(</span><span class="s">&#34;price&#34;</span><span class="o">,</span> <span class="n">SortOrder</span><span class="o">.</span><span class="na">ASC</span><span class="o">);</span>
    <span class="c1">// 2.3.分页
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">from</span><span class="o">((</span><span class="n">page</span><span class="o">-</span><span class="n">1</span><span class="o">)*</span><span class="n">size</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
    <span class="c1">// 3.发送请求
</span><span class="c1"></span>    <span class="n">SearchResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
    <span class="n">handleResponse</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>距离排序</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/6dceffc9ba094f5aa03f6bd248029f16.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/6dceffc9ba094f5aa03f6bd248029f16.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/6dceffc9ba094f5aa03f6bd248029f16.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/6dceffc9ba094f5aa03f6bd248029f16.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/6dceffc9ba094f5aa03f6bd248029f16.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<p><strong>5.高亮</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/62ae6484db674e83870a47e7f3cd615a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/62ae6484db674e83870a47e7f3cd615a.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/62ae6484db674e83870a47e7f3cd615a.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/62ae6484db674e83870a47e7f3cd615a.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/62ae6484db674e83870a47e7f3cd615a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testHighlight</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.创建Request对象
</span><span class="c1"></span>    <span class="n">SearchRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SearchRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">);</span>
    <span class="c1">// 2.准备请求参数；DSL语句
</span><span class="c1"></span>    <span class="c1">// 2.1.query
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">query</span><span class="o">(</span><span class="n">QueryBuilders</span><span class="o">.</span><span class="na">matchQuery</span><span class="o">(</span><span class="s">&#34;all&#34;</span><span class="o">,</span> <span class="s">&#34;如家&#34;</span><span class="o">));</span>
    <span class="c1">// 2.2.高亮
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">highlighter</span><span class="o">(</span><span class="k">new</span> <span class="n">HighlightBuilder</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">).</span><span class="na">requireFieldMatch</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
    <span class="c1">// 3.发送请求
</span><span class="c1"></span>    <span class="n">SearchResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
    <span class="n">handleResponse</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>高亮结果解析
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/69169aa9fadc4aaababda543c303b8e0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/69169aa9fadc4aaababda543c303b8e0.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/69169aa9fadc4aaababda543c303b8e0.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/69169aa9fadc4aaababda543c303b8e0.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/69169aa9fadc4aaababda543c303b8e0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" />
重写解析方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleResponse</span><span class="o">(</span><span class="n">SearchResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 4.解析响应
</span><span class="c1"></span>    <span class="n">SearchHits</span> <span class="n">searchHits</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getHits</span><span class="o">();</span>
    <span class="c1">// 4.1.获得总条数
</span><span class="c1"></span>    <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getTotalHits</span><span class="o">().</span><span class="na">value</span><span class="o">;</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">total</span><span class="o">);</span>
    <span class="c1">// 4.1.文档数组
</span><span class="c1"></span>    <span class="n">SearchHit</span><span class="o">[]</span> <span class="n">hits</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">.</span><span class="na">getHits</span><span class="o">();</span>
    <span class="c1">// 4.3.遍历
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">SearchHit</span> <span class="n">hit</span> <span class="o">:</span> <span class="n">hits</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 获取文档source
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getSourceAsString</span><span class="o">();</span>
        <span class="c1">// 反序列化
</span><span class="c1"></span>        <span class="n">HotelDoc</span> <span class="n">hotelDoc</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="n">HotelDoc</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 获取高亮结果
</span><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">HighlightField</span><span class="o">&gt;</span> <span class="n">highlightFields</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">getHighlightFields</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">highlightFields</span><span class="o">)){</span>
            <span class="c1">// 根据字段名获取高亮结果
</span><span class="c1"></span>            <span class="n">HighlightField</span> <span class="n">highlightField</span> <span class="o">=</span> <span class="n">highlightFields</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">);</span>
            <span class="c1">// 获取高亮值
</span><span class="c1"></span>            <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">highlightField</span><span class="o">.</span><span class="na">getFragments</span><span class="o">()[</span><span class="n">0</span><span class="o">].</span><span class="na">string</span><span class="o">();</span>
            <span class="c1">// 覆盖非高亮结果
</span><span class="c1"></span>            <span class="n">hotelDoc</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 覆盖非高亮值
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hotelDoc</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="十一数据聚合">十一.数据聚合</h2>
<p>聚合是对文档数据的统计、分析、计算</p>
<p>参与聚合的字段类型必须是：keyword，数值，日期，布尔</p>
<p>聚合常见的有三类：</p>
<ul>
<li>
<p>桶（Bucket）聚合：用来对文档做分组</p>
<ul>
<li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li>
<li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</li>
</ul>
</li>
<li>
<p>度量（Metric）聚合：用以计算一些值，比如：最大值、最小值、平均值等</p>
<ul>
<li>Avg：求平均值</li>
<li>Max：求最大值</li>
<li>Min：求最小值</li>
<li>Stats：同时求max、min、avg、sum等</li>
</ul>
</li>
<li>
<p>管道（pipeline）聚合：其它聚合的结果为基础做聚合</p>
</li>
</ul>
<p><strong>1.桶（Bucket）聚合</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/656d869010134790be40f62750a861ef.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_18,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/656d869010134790be40f62750a861ef.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_18%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/656d869010134790be40f62750a861ef.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_18%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/656d869010134790be40f62750a861ef.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_18%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/656d869010134790be40f62750a861ef.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_18,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/5c7e174389f9443e93e2111ada84eb99.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/5c7e174389f9443e93e2111ada84eb99.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/5c7e174389f9443e93e2111ada84eb99.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/5c7e174389f9443e93e2111ada84eb99.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/5c7e174389f9443e93e2111ada84eb99.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
默认情况下，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序</p>
<p>可以指定order属性，自定义聚合的排序方式</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/a2091c4b81234932b9c09626c2a0f282.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_12,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/a2091c4b81234932b9c09626c2a0f282.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_12%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/a2091c4b81234932b9c09626c2a0f282.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_12%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/a2091c4b81234932b9c09626c2a0f282.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_12%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/a2091c4b81234932b9c09626c2a0f282.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_12,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/6949ea80d9b442dc94e72c81e6ed738d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/6949ea80d9b442dc94e72c81e6ed738d.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/6949ea80d9b442dc94e72c81e6ed738d.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/6949ea80d9b442dc94e72c81e6ed738d.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/6949ea80d9b442dc94e72c81e6ed738d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
限定聚合范围</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/ec3a01e5896e4d6eacf357c4451f74b4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_11,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/ec3a01e5896e4d6eacf357c4451f74b4.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_11%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/ec3a01e5896e4d6eacf357c4451f74b4.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_11%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/ec3a01e5896e4d6eacf357c4451f74b4.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_11%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/ec3a01e5896e4d6eacf357c4451f74b4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_11,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/2ac556c373d9465590d074daf644e069.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/2ac556c373d9465590d074daf644e069.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/2ac556c373d9465590d074daf644e069.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/2ac556c373d9465590d074daf644e069.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/2ac556c373d9465590d074daf644e069.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p><strong>2. 度量（Metric）聚合</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/49d0192d966b4c4bb8d5219e2978b472.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_14,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/49d0192d966b4c4bb8d5219e2978b472.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_14%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/49d0192d966b4c4bb8d5219e2978b472.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_14%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/49d0192d966b4c4bb8d5219e2978b472.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_14%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/49d0192d966b4c4bb8d5219e2978b472.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_14,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/26b2927cb3dc4809bef3bf65e39733ed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/26b2927cb3dc4809bef3bf65e39733ed.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/26b2927cb3dc4809bef3bf65e39733ed.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/26b2927cb3dc4809bef3bf65e39733ed.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/26b2927cb3dc4809bef3bf65e39733ed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<h2 id="十二restclient数据聚合">十二.RestClient数据聚合</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/81e24f4bdad541f0be8ca76f50d025bf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/81e24f4bdad541f0be8ca76f50d025bf.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/81e24f4bdad541f0be8ca76f50d025bf.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/81e24f4bdad541f0be8ca76f50d025bf.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/81e24f4bdad541f0be8ca76f50d025bf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/09bf3e511c404a08abe11dcd38eaf01b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/09bf3e511c404a08abe11dcd38eaf01b.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/09bf3e511c404a08abe11dcd38eaf01b.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/09bf3e511c404a08abe11dcd38eaf01b.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/09bf3e511c404a08abe11dcd38eaf01b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testAggregation</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.准备Request
</span><span class="c1"></span>    <span class="n">SearchRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SearchRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">);</span>
    <span class="c1">// 2.准备DSL
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">size</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">aggregation</span><span class="o">(</span><span class="n">AggregationBuilders</span>
            <span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">&#34;brandAgg&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">&#34;brand&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">10</span><span class="o">)</span>
    <span class="o">);</span>
    <span class="c1">// 3.发出请求
</span><span class="c1"></span>    <span class="n">SearchResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
    <span class="c1">// 4.解析结果
</span><span class="c1"></span>    <span class="n">Aggregations</span> <span class="n">aggregations</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getAggregations</span><span class="o">();</span>
    <span class="c1">// 4.1.根据聚合名称获取聚合结果
</span><span class="c1"></span>    <span class="n">Terms</span> <span class="n">brandTerms</span> <span class="o">=</span> <span class="n">aggregations</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;brandAgg&#34;</span><span class="o">);</span>
    <span class="c1">// 4.2.获取buckets
</span><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span><span class="o">&gt;</span> <span class="n">buckets</span> <span class="o">=</span> <span class="n">brandTerms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">();</span>
    <span class="c1">// 4.3.遍历
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">buckets</span><span class="o">){</span>
        <span class="c1">// 4.4.获取key
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="十三自动补全">十三.自动补全</h2>
<p><strong>1.拼音分词器</strong></p>
<p>要实现根据字母做补全，就必须对文档按照拼音分词。
在GitHub上有elasticsearch的拼音分词插件。
地址：https://github.com/medcl/elasticsearch-analysis-pinyin</p>
<p><strong>2.自定义分词器</strong></p>
<p>elasticsearch中分词器（analyzer）的组成包含三部分：</p>
<p>character filters：在tokenizer之前对文本进行处理。例如删除字符、替换字符
tokenizer：将文本按照一定的规则切割成词条（term）。例如keyword，就是不分词；还有ik_smart
tokenizer filter：将tokenizer输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理等</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/f0db1f22b74a4080b4ada12de9c9b508.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/f0db1f22b74a4080b4ada12de9c9b508.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/f0db1f22b74a4080b4ada12de9c9b508.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/f0db1f22b74a4080b4ada12de9c9b508.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/f0db1f22b74a4080b4ada12de9c9b508.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" />参考官网配置</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/447b0a3c66d84566b8af1211829f90e8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/447b0a3c66d84566b8af1211829f90e8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/447b0a3c66d84566b8af1211829f90e8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/447b0a3c66d84566b8af1211829f90e8.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/447b0a3c66d84566b8af1211829f90e8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" /></p>
<p>自定义分词器语法如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">PUT</span> <span class="err">/test</span>
<span class="p">{</span>
  <span class="nt">&#34;settings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;analysis&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 自定义分词器
</span><span class="c1"></span>        <span class="nt">&#34;my_analyzer&#34;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// 分词器名称
</span><span class="c1"></span>          <span class="nt">&#34;tokenizer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_max_word&#34;</span><span class="p">,</span>
          <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="s2">&#34;py&#34;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 自定义tokenizer filter
</span><span class="c1"></span>        <span class="nt">&#34;py&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 过滤器名称
</span><span class="c1"></span>          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;pinyin&#34;</span><span class="p">,</span> <span class="c1">// 过滤器类型，这里是pinyin
</span><span class="c1"></span>		  <span class="nt">&#34;keep_full_pinyin&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&#34;keep_joined_full_pinyin&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&#34;keep_original&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&#34;limit_first_letter_length&#34;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
          <span class="nt">&#34;remove_duplicated_term&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&#34;none_chinese_pinyin_tokenize&#34;</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
        <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;my_analyzer&#34;</span><span class="p">,</span>
        <span class="nt">&#34;search_analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_smart&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><blockquote>
<p>拼音分词器注意事项：</p>
<p>为了避免搜索到同音字，搜索时不要使用拼音分词器</p>
</blockquote>
<p><strong>3.自动补全</strong></p>
<p>elasticsearch提供了Completion Suggester查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回</p>
<p>官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html</p>
<p>为了提高补全查询的效率，对于文档中字段的类型有一些约束：</p>
<ul>
<li>
<p>参与补全查询的字段必须是completion类型。</p>
</li>
<li>
<p>字段的内容一般是用来补全的多个词条形成的数组。</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/bc3e628db00c4b94927c00198026a463.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/bc3e628db00c4b94927c00198026a463.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/bc3e628db00c4b94927c00198026a463.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/bc3e628db00c4b94927c00198026a463.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/bc3e628db00c4b94927c00198026a463.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/a7ad6301d1094c328d989ad17adc1fd2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_11,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/a7ad6301d1094c328d989ad17adc1fd2.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_11%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/a7ad6301d1094c328d989ad17adc1fd2.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_11%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/a7ad6301d1094c328d989ad17adc1fd2.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_11%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/a7ad6301d1094c328d989ad17adc1fd2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_11,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/1b81e618acf6431fb7956b7f2a25a03f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/1b81e618acf6431fb7956b7f2a25a03f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/1b81e618acf6431fb7956b7f2a25a03f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/1b81e618acf6431fb7956b7f2a25a03f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/1b81e618acf6431fb7956b7f2a25a03f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/b9177a16918a4eb7b67276c292acc5b3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/b9177a16918a4eb7b67276c292acc5b3.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/b9177a16918a4eb7b67276c292acc5b3.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/b9177a16918a4eb7b67276c292acc5b3.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/b9177a16918a4eb7b67276c292acc5b3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testSuggestion</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// 1.准备Request
</span><span class="c1"></span>    <span class="n">SearchRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SearchRequest</span><span class="o">(</span><span class="s">&#34;hotel&#34;</span><span class="o">);</span>
    <span class="c1">// 2.准备DSL
</span><span class="c1"></span>    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">suggest</span><span class="o">(</span><span class="k">new</span> <span class="n">SuggestBuilder</span><span class="o">().</span><span class="na">addSuggestion</span><span class="o">(</span>
            <span class="s">&#34;suggestion&#34;</span><span class="o">,</span>
            <span class="n">SuggestBuilders</span><span class="o">.</span><span class="na">completionSuggestion</span><span class="o">(</span><span class="s">&#34;suggestion&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">prefix</span><span class="o">(</span><span class="s">&#34;h&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">skipDuplicates</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
            <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">10</span><span class="o">)</span>
    <span class="o">));</span>
    <span class="c1">// 3.发起请求
</span><span class="c1"></span>    <span class="n">SearchResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
    <span class="c1">// 4.解析结果
</span><span class="c1"></span>    <span class="n">Suggest</span> <span class="n">suggest</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getSuggest</span><span class="o">();</span>
    <span class="c1">// 4.1.根据补全查询名称，获取补全结果
</span><span class="c1"></span>    <span class="n">CompletionSuggestion</span> <span class="n">suggestion</span> <span class="o">=</span> <span class="n">suggest</span><span class="o">.</span><span class="na">getSuggestion</span><span class="o">(</span><span class="s">&#34;suggestion&#34;</span><span class="o">);</span>
    <span class="c1">// 4.2.获取options
</span><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">CompletionSuggestion</span><span class="o">.</span><span class="na">Entry</span><span class="o">.</span><span class="na">Option</span><span class="o">&gt;</span> <span class="n">options</span> <span class="o">=</span> <span class="n">suggestion</span><span class="o">.</span><span class="na">getOptions</span><span class="o">();</span>
    <span class="k">for</span><span class="o">(</span><span class="n">CompletionSuggestion</span><span class="o">.</span><span class="na">Entry</span><span class="o">.</span><span class="na">Option</span> <span class="n">option</span> <span class="o">:</span> <span class="n">options</span><span class="o">){</span>
        <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h2 id="十四数据同步">十四.数据同步</h2>
<p>elasticsearch中的酒店数据来自于mysql数据库，因此mysql数据发生改变时，elasticsearch也必须跟着改变，这个就是elasticsearch与mysql之间的数据同步</p>
<p>常见的数据同步方案有三种：</p>
<ul>
<li>同步调用</li>
<li>异步通知</li>
<li>监听binlog</li>
</ul>
<p><strong>1.方式一：同步调用</strong></p>
<ul>
<li>优点：实现简单，粗暴</li>
<li>缺点：业务耦合度高</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/f0d561df243141729fdcb79d880e3109.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/f0d561df243141729fdcb79d880e3109.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/f0d561df243141729fdcb79d880e3109.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/f0d561df243141729fdcb79d880e3109.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/f0d561df243141729fdcb79d880e3109.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<p><strong>2.方式二：异步通知</strong></p>
<ul>
<li>优点：低耦合，实现难度一般</li>
<li>缺点：依赖mq的可靠性</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/6cb226ab0d904f8d8b110fde3dbf5134.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/6cb226ab0d904f8d8b110fde3dbf5134.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/6cb226ab0d904f8d8b110fde3dbf5134.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/6cb226ab0d904f8d8b110fde3dbf5134.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/6cb226ab0d904f8d8b110fde3dbf5134.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<p><strong>3.方式三：监听binlog</strong></p>
<ul>
<li>优点：完全解除服务间耦合</li>
<li>缺点：开启binlog增加数据库负担、实现复杂度高</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/7f38a1639f1943beb2f3cf33c3400175.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/7f38a1639f1943beb2f3cf33c3400175.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/7f38a1639f1943beb2f3cf33c3400175.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/7f38a1639f1943beb2f3cf33c3400175.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/7f38a1639f1943beb2f3cf33c3400175.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<h2 id="十五es集群">十五.ES集群</h2>
<p>单机的elasticsearch做数据存储，必然面临两个问题：海量数据存储问题、单点故障问题。</p>
<ul>
<li>海量数据存储问题：将索引库从逻辑上拆分为N个分片（shard），存储到多个节点</li>
<li>单点故障问题：将分片数据在不同节点备份（replica ）</li>
</ul>
<p>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高了</p>
<p>为了在高可用和成本间寻求平衡，我们可以这样做：</p>
<ul>
<li>首先对数据分片，存储到不同节点</li>
<li>然后对每个分片进行备份，放到对方节点，完成互相备份</li>
</ul>
<p>这样可以大大减少所需要的服务节点数量</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/8f6995ee34ca451c90567f5ec43eed9f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/8f6995ee34ca451c90567f5ec43eed9f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/8f6995ee34ca451c90567f5ec43eed9f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/8f6995ee34ca451c90567f5ec43eed9f.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/8f6995ee34ca451c90567f5ec43eed9f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" />
<strong>1.部署es集群</strong></p>
<p>使用docker-compose</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-docker" data-lang="docker">version: <span class="s1">&#39;2.2&#39;</span><span class="err">
</span><span class="err"></span>services:<span class="err">
</span><span class="err"></span>  es01:<span class="err">
</span><span class="err"></span>    image: elasticsearch:7.12.1<span class="err">
</span><span class="err"></span>    container_name: es01<span class="err">
</span><span class="err"></span>    environment:<span class="err">
</span><span class="err"></span>      - node.name<span class="o">=</span>es01<span class="err">
</span><span class="err"></span>      - cluster.name<span class="o">=</span>es-docker-cluster<span class="err">
</span><span class="err"></span>      - discovery.seed_hosts<span class="o">=</span>es02,es03<span class="err">
</span><span class="err"></span>      - cluster.initial_master_nodes<span class="o">=</span>es01,es02,es03<span class="err">
</span><span class="err"></span>      - <span class="s2">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span><span class="err">
</span><span class="err"></span>    volumes:<span class="err">
</span><span class="err"></span>      - data01:/usr/share/elasticsearch/data<span class="err">
</span><span class="err"></span>    ports:<span class="err">
</span><span class="err"></span>      - 9200:9200<span class="err">
</span><span class="err"></span>    networks:<span class="err">
</span><span class="err"></span>      - elastic<span class="err">
</span><span class="err"></span>  es02:<span class="err">
</span><span class="err"></span>    image: elasticsearch:7.12.1<span class="err">
</span><span class="err"></span>    container_name: es02<span class="err">
</span><span class="err"></span>    environment:<span class="err">
</span><span class="err"></span>      - node.name<span class="o">=</span>es02<span class="err">
</span><span class="err"></span>      - cluster.name<span class="o">=</span>es-docker-cluster<span class="err">
</span><span class="err"></span>      - discovery.seed_hosts<span class="o">=</span>es01,es03<span class="err">
</span><span class="err"></span>      - cluster.initial_master_nodes<span class="o">=</span>es01,es02,es03<span class="err">
</span><span class="err"></span>      - <span class="s2">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span><span class="err">
</span><span class="err"></span>    volumes:<span class="err">
</span><span class="err"></span>      - data02:/usr/share/elasticsearch/data<span class="err">
</span><span class="err"></span>    ports:<span class="err">
</span><span class="err"></span>      - 9201:9200<span class="err">
</span><span class="err"></span>    networks:<span class="err">
</span><span class="err"></span>      - elastic<span class="err">
</span><span class="err"></span>  es03:<span class="err">
</span><span class="err"></span>    image: elasticsearch:7.12.1<span class="err">
</span><span class="err"></span>    container_name: es03<span class="err">
</span><span class="err"></span>    environment:<span class="err">
</span><span class="err"></span>      - node.name<span class="o">=</span>es03<span class="err">
</span><span class="err"></span>      - cluster.name<span class="o">=</span>es-docker-cluster<span class="err">
</span><span class="err"></span>      - discovery.seed_hosts<span class="o">=</span>es01,es02<span class="err">
</span><span class="err"></span>      - cluster.initial_master_nodes<span class="o">=</span>es01,es02,es03<span class="err">
</span><span class="err"></span>      - <span class="s2">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span><span class="err">
</span><span class="err"></span>    volumes:<span class="err">
</span><span class="err"></span>      - data03:/usr/share/elasticsearch/data<span class="err">
</span><span class="err"></span>    networks:<span class="err">
</span><span class="err"></span>      - elastic<span class="err">
</span><span class="err"></span>    ports:<span class="err">
</span><span class="err"></span>      - 9202:9200<span class="err">
</span><span class="err"></span>volumes:<span class="err">
</span><span class="err"></span>  data01:<span class="err">
</span><span class="err"></span>    driver: local<span class="err">
</span><span class="err"></span>  data02:<span class="err">
</span><span class="err"></span>    driver: local<span class="err">
</span><span class="err"></span>  data03:<span class="err">
</span><span class="err"></span>    driver: local<span class="err">
</span><span class="err">
</span><span class="err"></span>networks:<span class="err">
</span><span class="err"></span>  elastic:<span class="err">
</span><span class="err"></span>    driver: bridge<span class="err">
</span></code></pre></div><p>es运行需要修改一些linux系统权限，修改<code>/etc/sysctl.conf</code>文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">vi /etc/sysctl.conf
</code></pre></div><p>添加下面的内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">vm.max_map_count<span class="o">=</span><span class="m">262144</span>
</code></pre></div><p>然后执行命令，让配置生效：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sysctl -p
</code></pre></div><p>通过docker-compose启动集群：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker-compose up -d
</code></pre></div><p><strong>2.集群状态监控</strong></p>
<p>kibana可以监控es集群，不过新版本需要依赖es的x-pack 功能，配置比较复杂。</p>
<p>这里使用cerebro来监控es集群状态</p>
<p>官方网址：https://github.com/lmenezes/cerebro</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/18e32cec8bc34fb9885be7612349f4e1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/18e32cec8bc34fb9885be7612349f4e1.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/18e32cec8bc34fb9885be7612349f4e1.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/18e32cec8bc34fb9885be7612349f4e1.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/18e32cec8bc34fb9885be7612349f4e1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="在这里插入图片描述" />
启动后输入es地址即可监控</p>
<p><strong>3.创建索引库</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">PUT</span> <span class="err">/itcast</span>
<span class="p">{</span>
  <span class="nt">&#34;settings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;number_of_shards&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="c1">// 分片数量
</span><span class="c1"></span>    <span class="nt">&#34;number_of_replicas&#34;</span><span class="p">:</span> <span class="mi">1</span> <span class="c1">// 副本数量
</span><span class="c1"></span>  <span class="p">},</span>
  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">// mapping映射定义 ...
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/ffee562441204861ace314bc64ca8cf6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/ffee562441204861ace314bc64ca8cf6.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/ffee562441204861ace314bc64ca8cf6.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/ffee562441204861ace314bc64ca8cf6.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/ffee562441204861ace314bc64ca8cf6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" />
<strong>4.es集群节点角色</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/09d1eb282b17433e9464d0dc870b2e19.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/09d1eb282b17433e9464d0dc870b2e19.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/09d1eb282b17433e9464d0dc870b2e19.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/09d1eb282b17433e9464d0dc870b2e19.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/09d1eb282b17433e9464d0dc870b2e19.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<ul>
<li>master节点：对CPU要求高，但是内存要求低</li>
<li>data节点：对CPU和内存要求都高</li>
<li>coordinating节点：对网络带宽、CPU要求高</li>
</ul>
<p>职责分离可以让我们根据不同节点的需求分配不同的硬件去部署。而且避免业务之间的互相干扰。</p>
<blockquote>
<p>master eligible节点</p>
<ul>
<li>参与集群选主</li>
<li>主节点可以管理集群状态、管理分片信息、处理创建和删除索引库的请求</li>
</ul>
<p>data节点</p>
<ul>
<li>数据的CRUD</li>
</ul>
<p>coordinator节点</p>
<ul>
<li>
<p>路由请求到其它节点</p>
</li>
<li>
<p>合并查询到的结果，返回给用户</p>
</li>
</ul>
</blockquote>
<p>一个典型的es集群职责划分如图：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/acfaedc5622a4f48b1e9bd565e343991.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/acfaedc5622a4f48b1e9bd565e343991.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/acfaedc5622a4f48b1e9bd565e343991.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/acfaedc5622a4f48b1e9bd565e343991.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/acfaedc5622a4f48b1e9bd565e343991.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" />
<strong>5.脑裂</strong></p>
<p>脑裂是因为集群中的节点失联导致的。</p>
<p>例如一个集群中，主节点与其它节点失联：</p>
<p>此时，node2和node3认为node1宕机，就会重新选主：</p>
<p>当node3当选后，集群继续对外提供服务，node2和node3自成集群，node1自成集群，两个集群数据不同步，出现数据差异。</p>
<p>当网络恢复后，因为集群中有两个master节点，集群状态的不一致，出现脑裂的情况：</p>
<p>解决脑裂的方案是，要求选票超过 ( eligible节点数量 + 1 ）/ 2 才能当选为主，因此eligible节点数量最好是奇数。对应配置项是discovery.zen.minimum_master_nodes，在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题</p>
<p>例如：3个节点形成的集群，选票必须超过 （3 + 1） / 2 ，也就是2票。node3得到node2和node3的选票，当选为主。node1只有自己1票，没有当选。集群中依然只有1个主节点，没有出现脑裂。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/8d6e18610f2547d9be0dc870be7154b4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/8d6e18610f2547d9be0dc870be7154b4.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/8d6e18610f2547d9be0dc870be7154b4.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/8d6e18610f2547d9be0dc870be7154b4.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/8d6e18610f2547d9be0dc870be7154b4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" />
<strong>6.分片存储原理</strong>
elasticsearch会通过hash算法来计算文档应该存储到哪个分片：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/b24c1a70883d4112bde9241afa636f47.png"
        data-srcset="https://img-blog.csdnimg.cn/b24c1a70883d4112bde9241afa636f47.png, https://img-blog.csdnimg.cn/b24c1a70883d4112bde9241afa636f47.png 1.5x, https://img-blog.csdnimg.cn/b24c1a70883d4112bde9241afa636f47.png 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/b24c1a70883d4112bde9241afa636f47.png"
        title="请添加图片描述" /></p>
<p>说明：</p>
<ul>
<li>_routing默认是文档的id</li>
<li>算法与分片数量有关，因此索引库一旦创建，分片数量不能修改！</li>
</ul>
<p>新增文档的流程如下：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/cfc54d36a66744c38316e4df20e8c234.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/cfc54d36a66744c38316e4df20e8c234.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/cfc54d36a66744c38316e4df20e8c234.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/cfc54d36a66744c38316e4df20e8c234.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/cfc54d36a66744c38316e4df20e8c234.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<p>解读：</p>
<ul>
<li>1）新增一个id=1的文档</li>
<li>2）对id做hash运算，假如得到的是2，则应该存储到shard-2</li>
<li>3）shard-2的主分片在node3节点，将数据路由到node3</li>
<li>4）保存文档</li>
<li>5）同步给shard-2的副本replica-2，在node2节点</li>
<li>6）返回结果给coordinating-node节点</li>
</ul>
<p><strong>7.集群分布式查询</strong>
elasticsearch的查询分成两个阶段：</p>
<ul>
<li>
<p>scatter phase：分散阶段，coordinating node会把请求分发到每一个分片</p>
</li>
<li>
<p>gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/ffe0248d1c644783aad007a2520130a9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/ffe0248d1c644783aad007a2520130a9.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/ffe0248d1c644783aad007a2520130a9.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/ffe0248d1c644783aad007a2520130a9.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/ffe0248d1c644783aad007a2520130a9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<p><strong>8.集群故障转移</strong></p>
<p>集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://img-blog.csdnimg.cn/5546094b04e74a93b79dc197c3d77217.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        data-srcset="https://img-blog.csdnimg.cn/5546094b04e74a93b79dc197c3d77217.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16, https://img-blog.csdnimg.cn/5546094b04e74a93b79dc197c3d77217.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 1.5x, https://img-blog.csdnimg.cn/5546094b04e74a93b79dc197c3d77217.png?x-oss-process=image/watermark%2ctype_d3F5LXplbmhlaQ%2cshadow_50%2ctext_Q1NETiBASGVucmlrLVlhbw==%2csize_20%2ccolor_FFFFFF%2ct_70%2cg_se%2cx_16 2x"
        data-sizes="auto"
        alt="https://img-blog.csdnimg.cn/5546094b04e74a93b79dc197c3d77217.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBASGVucmlrLVlhbw==,size_20,color_FFFFFF,t_70,g_se,x_16"
        title="请添加图片描述" /></p>
<h2 id="十六附录">十六.附录</h2>
<h4 id="1相关代码">1.相关代码</h4>
<p>github仓库：https://github.com/Henrik-Yao/Hotel-ES</p>
<h4 id="2相关dsl">2.相关DSL</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">GET</span> <span class="err">/</span>

<span class="err">GET</span> <span class="err">_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match_all&#34;</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">POST</span> <span class="err">/_analyze</span>
<span class="p">{</span>
 <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;宁可卷死自己，不让其他人休息&#34;</span><span class="p">,</span>
 <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_smart&#34;</span>
<span class="p">}</span>


<span class="err">POST</span> <span class="err">/_analyze</span>
<span class="p">{</span>
 <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;宁可卷死自己，不让其他人休息&#34;</span><span class="p">,</span>
 <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_max_word&#34;</span>
<span class="p">}</span>

<span class="err">POST</span> <span class="err">/_analyze</span>
<span class="p">{</span>
 <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;不洗碗工作室宁可卷死自己，不让其他人休息&#34;</span><span class="p">,</span>
 <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_smart&#34;</span>
<span class="p">}</span>


<span class="err">PUT</span> <span class="err">/test</span>
<span class="p">{</span>
  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;info&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
        <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_smart&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;email&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
        <span class="nt">&#34;index&#34;</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">},</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
        <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;firstName&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
            <span class="nt">&#34;index&#34;</span><span class="p">:</span> <span class="kc">false</span>
          <span class="p">},</span>
          <span class="nt">&#34;lastName&#34;</span><span class="p">:{</span>
            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
            <span class="nt">&#34;index&#34;</span><span class="p">:</span> <span class="kc">false</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">GET</span> <span class="err">/test</span>


<span class="err">DELETE</span> <span class="err">/test</span>


<span class="err">PUT</span> <span class="err">/test/_mapping</span>
<span class="p">{</span>
  <span class="nt">&#34;properties&#34;</span><span class="p">:{</span>
    <span class="nt">&#34;age&#34;</span><span class="p">:{</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span><span class="s2">&#34;integer&#34;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">POST</span> <span class="err">/test/_doc/</span><span class="mi">1</span>
<span class="p">{</span>
  <span class="nt">&#34;info&#34;</span><span class="p">:</span><span class="s2">&#34;不洗碗工作室&#34;</span><span class="p">,</span>
  <span class="nt">&#34;email&#34;</span><span class="p">:</span><span class="s2">&#34;henrik@qq.com&#34;</span><span class="p">,</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;firstName&#34;</span><span class="p">:</span><span class="s2">&#34;云&#34;</span><span class="p">,</span>
    <span class="nt">&#34;lastName&#34;</span><span class="p">:</span><span class="s2">&#34;赵&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">GET</span> <span class="err">/test/_doc/</span><span class="mi">1</span>



<span class="err">DELETE</span> <span class="err">/test/_doc/</span><span class="mi">1</span>


<span class="err">PUT</span> <span class="err">/test/_doc/</span><span class="mi">1</span>
<span class="p">{</span>
  <span class="nt">&#34;info&#34;</span><span class="p">:</span><span class="s2">&#34;不洗碗工作室&#34;</span><span class="p">,</span>
  <span class="nt">&#34;email&#34;</span><span class="p">:</span><span class="s2">&#34;henrik@qq.com&#34;</span><span class="p">,</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;firstName&#34;</span><span class="p">:</span><span class="s2">&#34;云&#34;</span><span class="p">,</span>
    <span class="nt">&#34;lastName&#34;</span><span class="p">:</span><span class="s2">&#34;赵&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>



<span class="err">POST</span> <span class="err">/test/_update/</span><span class="mi">1</span>
<span class="p">{</span>
  <span class="nt">&#34;doc&#34;</span><span class="p">:{</span>
    <span class="nt">&#34;email&#34;</span><span class="p">:</span><span class="s2">&#34;henrik-yao@qq.com&#34;</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">GET</span> <span class="err">/hotel</span>


<span class="err">DELETE</span> <span class="err">/hotel</span>



<span class="err">GET</span> <span class="err">/hotel/_doc/</span><span class="mi">61083</span>



<span class="err">GET</span> <span class="err">/hotel/_search</span>


<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match_all&#34;</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">}</span>





<span class="err">GET</span> <span class="err">/indexName/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;查询类型&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;查询条件&#34;</span><span class="p">:</span> <span class="s2">&#34;条件值&#34;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>





<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;all&#34;</span><span class="p">:</span> <span class="s2">&#34;外滩如家&#34;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">DELETE</span> <span class="err">/hotel</span>



<span class="err">PUT</span> <span class="err">/hotel</span>
<span class="p">{</span>
  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
        <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_max_word&#34;</span><span class="p">,</span>
        <span class="nt">&#34;copy_to&#34;</span><span class="p">:</span> <span class="s2">&#34;all&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
        <span class="nt">&#34;index&#34;</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">},</span>
      <span class="nt">&#34;price&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;integer&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;score&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;integer&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;brand&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
        <span class="nt">&#34;copy_to&#34;</span><span class="p">:</span> <span class="s2">&#34;all&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;city&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;starName&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;business&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
        <span class="nt">&#34;copy_to&#34;</span><span class="p">:</span> <span class="s2">&#34;all&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;pic&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
        <span class="nt">&#34;index&#34;</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">},</span>
      <span class="nt">&#34;location&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;geo_point&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;all&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
        <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_max_word&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>



<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;all&#34;</span><span class="p">:</span> <span class="s2">&#34;外滩如家&#34;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>



<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;multi_match&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="s2">&#34;外滩如家&#34;</span><span class="p">,</span>
      <span class="nt">&#34;fields&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;brand&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">,</span><span class="s2">&#34;business&#34;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>




<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;term&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;city&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;上海&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>



<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;range&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;price&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;gte&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nt">&#34;lte&#34;</span><span class="p">:</span> <span class="mi">200</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>



<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;geo_distance&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;distance&#34;</span><span class="p">:</span> <span class="s2">&#34;15km&#34;</span><span class="p">,</span>
      <span class="nt">&#34;location&#34;</span><span class="p">:</span> <span class="s2">&#34;31.21,121.5&#34;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>




<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;function_score&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;all&#34;</span><span class="p">:</span> <span class="s2">&#34;外滩&#34;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;functions&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;term&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;brand&#34;</span><span class="p">:</span> <span class="s2">&#34;如家&#34;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&#34;weight&#34;</span><span class="p">:</span> <span class="mi">10</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&#34;boost_mode&#34;</span><span class="p">:</span> <span class="s2">&#34;sum&#34;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>





<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;bool&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;must&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;如家&#34;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&#34;must_not&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&#34;range&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;price&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;gt&#34;</span><span class="p">:</span> <span class="mi">400</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&#34;geo_distance&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;distance&#34;</span><span class="p">:</span> <span class="s2">&#34;10km&#34;</span><span class="p">,</span>
            <span class="nt">&#34;location&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;lat&#34;</span><span class="p">:</span> <span class="mf">31.21</span><span class="p">,</span>
              <span class="nt">&#34;lon&#34;</span><span class="p">:</span> <span class="mf">121.5</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>




<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match_all&#34;</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">},</span>
  <span class="nt">&#34;sort&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;score&#34;</span><span class="p">:</span> <span class="s2">&#34;desc&#34;</span> 
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&#34;price&#34;</span><span class="p">:</span> <span class="s2">&#34;asc&#34;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>





<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match_all&#34;</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">},</span>
  <span class="nt">&#34;sort&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;_geo_distance&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;location&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;lat&#34;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
          <span class="nt">&#34;lon&#34;</span><span class="p">:</span> <span class="mi">121</span>
        <span class="p">},</span>
        <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="s2">&#34;asc&#34;</span><span class="p">,</span>
        <span class="nt">&#34;unit&#34;</span><span class="p">:</span> <span class="s2">&#34;km&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>



<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match_all&#34;</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">},</span>
  <span class="nt">&#34;sort&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;price&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="s2">&#34;asc&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&#34;from&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">20</span>
<span class="p">}</span>



<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match_all&#34;</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">},</span>
  <span class="nt">&#34;sort&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;price&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="s2">&#34;asc&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&#34;from&#34;</span><span class="p">:</span> <span class="mi">9999</span><span class="p">,</span>
  <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">20</span>
<span class="p">}</span>


<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;all&#34;</span><span class="p">:</span> <span class="s2">&#34;如家&#34;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&#34;highlight&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;fields&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;require_field_match&#34;</span><span class="p">:</span> <span class="s2">&#34;false&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>




<span class="err">POST</span> <span class="err">/hotel/_update/</span><span class="mi">2056126831</span>
<span class="p">{</span>
    <span class="nt">&#34;doc&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;isAD&#34;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">POST</span> <span class="err">/hotel/_update/</span><span class="mi">1989806195</span>
<span class="p">{</span>
    <span class="nt">&#34;doc&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;isAD&#34;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">POST</span> <span class="err">/hotel/_update/</span><span class="mi">2056105938</span>
<span class="p">{</span>
    <span class="nt">&#34;doc&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;isAD&#34;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;isAD&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>



<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;aggs&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;brandAgg&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;terms&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;field&#34;</span><span class="p">:</span> <span class="s2">&#34;brand&#34;</span><span class="p">,</span>
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">10</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;aggs&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;brandAgg&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;terms&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;field&#34;</span><span class="p">:</span> <span class="s2">&#34;brand&#34;</span><span class="p">,</span>
        <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;_count&#34;</span><span class="p">:</span> <span class="s2">&#34;asc&#34;</span>
        <span class="p">},</span> 
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">10</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;range&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;price&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;lte&#34;</span><span class="p">:</span> <span class="mi">200</span> 
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span> 
  <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="nt">&#34;aggs&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;brandAgg&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;terms&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;field&#34;</span><span class="p">:</span> <span class="s2">&#34;brand&#34;</span><span class="p">,</span>
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">20</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="nt">&#34;aggs&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;brandAgg&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;terms&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;field&#34;</span><span class="p">:</span> <span class="s2">&#34;brand&#34;</span><span class="p">,</span>
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">20</span>
      <span class="p">},</span>
      <span class="nt">&#34;aggs&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;scoreAgg&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;stats&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;field&#34;</span><span class="p">:</span> <span class="s2">&#34;score&#34;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="nt">&#34;aggs&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;brandAgg&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;terms&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;field&#34;</span><span class="p">:</span> <span class="s2">&#34;brand&#34;</span><span class="p">,</span>
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="nt">&#34;order&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;scoreAgg.avg&#34;</span><span class="p">:</span> <span class="s2">&#34;desc&#34;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;aggs&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;scoreAgg&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;stats&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;field&#34;</span><span class="p">:</span> <span class="s2">&#34;score&#34;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">GET</span> <span class="err">/</span>


<span class="err">POST</span> <span class="err">/_analyze</span>
<span class="p">{</span>
  <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;不洗碗工作室&#34;</span><span class="p">],</span>
  <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;pinyin&#34;</span>
<span class="p">}</span>

<span class="err">DELETE</span> <span class="err">/test</span>

<span class="err">PUT</span> <span class="err">/test</span>
<span class="p">{</span>
  <span class="nt">&#34;settings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;analysis&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="p">{</span> 
        <span class="nt">&#34;my_analyzer&#34;</span><span class="p">:</span> <span class="p">{</span> 
          <span class="nt">&#34;tokenizer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_max_word&#34;</span><span class="p">,</span>
          <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="s2">&#34;py&#34;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="p">{</span> 
        <span class="nt">&#34;py&#34;</span><span class="p">:</span> <span class="p">{</span> 
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;pinyin&#34;</span><span class="p">,</span>
		  <span class="nt">&#34;keep_full_pinyin&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&#34;keep_joined_full_pinyin&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&#34;keep_original&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&#34;limit_first_letter_length&#34;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
          <span class="nt">&#34;remove_duplicated_term&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&#34;none_chinese_pinyin_tokenize&#34;</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
        <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;my_analyzer&#34;</span><span class="p">,</span>
        <span class="nt">&#34;search_analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_smart&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>



<span class="err">POST</span> <span class="err">/test/_doc/</span><span class="mi">1</span>
<span class="p">{</span>
  <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;狮子&#34;</span>
<span class="p">}</span>
<span class="err">POST</span> <span class="err">/test/_doc/</span><span class="mi">2</span>
<span class="p">{</span>
  <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;虱子&#34;</span>
<span class="p">}</span>

<span class="err">GET</span> <span class="err">/test/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;掉入狮子笼咋办&#34;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 自动补全的索引库
</span><span class="c1"></span><span class="err">PUT</span> <span class="err">test</span><span class="mi">2</span>
<span class="p">{</span>
  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;title&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;completion&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// 示例数据
</span><span class="c1"></span><span class="err">POST</span> <span class="err">test</span><span class="mi">2</span><span class="err">/_doc</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;Sony&#34;</span><span class="p">,</span> <span class="s2">&#34;WH-1000XM3&#34;</span><span class="p">]</span>
<span class="p">}</span>
<span class="err">POST</span> <span class="err">test</span><span class="mi">2</span><span class="err">/_doc</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;SK-II&#34;</span><span class="p">,</span> <span class="s2">&#34;PITERA&#34;</span><span class="p">]</span>
<span class="p">}</span>
<span class="err">POST</span> <span class="err">test</span><span class="mi">2</span><span class="err">/_doc</span>
<span class="p">{</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;Nintendo&#34;</span><span class="p">,</span> <span class="s2">&#34;switch&#34;</span><span class="p">]</span>
<span class="p">}</span>

<span class="err">POST</span> <span class="err">test</span><span class="mi">2</span><span class="err">/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match_all&#34;</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">#</span> <span class="err">自动补全查询</span>
<span class="err">POST</span> <span class="err">/test</span><span class="mi">2</span><span class="err">/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;suggest&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;title_suggest&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;s&#34;</span><span class="p">,</span> 
      <span class="nt">&#34;completion&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;field&#34;</span><span class="p">:</span> <span class="s2">&#34;title&#34;</span><span class="p">,</span> 
        <span class="nt">&#34;skip_duplicates&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> 
        <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">10</span> 
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="err">GET</span> <span class="err">/hotel/_mapping</span>

<span class="err">DELETE</span> <span class="err">/hotel</span>

<span class="err">#</span> <span class="err">酒店数据索引库</span>
<span class="err">PUT</span> <span class="err">/hotel</span>
<span class="p">{</span>
  <span class="nt">&#34;settings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;analysis&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;text_anlyzer&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;tokenizer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_max_word&#34;</span><span class="p">,</span>
          <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="s2">&#34;py&#34;</span>
        <span class="p">},</span>
        <span class="nt">&#34;completion_analyzer&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;tokenizer&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
          <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="s2">&#34;py&#34;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;py&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;pinyin&#34;</span><span class="p">,</span>
          <span class="nt">&#34;keep_full_pinyin&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&#34;keep_joined_full_pinyin&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&#34;keep_original&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&#34;limit_first_letter_length&#34;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
          <span class="nt">&#34;remove_duplicated_term&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&#34;none_chinese_pinyin_tokenize&#34;</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;id&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
        <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;text_anlyzer&#34;</span><span class="p">,</span>
        <span class="nt">&#34;search_analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_smart&#34;</span><span class="p">,</span>
        <span class="nt">&#34;copy_to&#34;</span><span class="p">:</span> <span class="s2">&#34;all&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;address&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
        <span class="nt">&#34;index&#34;</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">},</span>
      <span class="nt">&#34;price&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;integer&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;score&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;integer&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;brand&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
        <span class="nt">&#34;copy_to&#34;</span><span class="p">:</span> <span class="s2">&#34;all&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;city&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;starName&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;business&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
        <span class="nt">&#34;copy_to&#34;</span><span class="p">:</span> <span class="s2">&#34;all&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;location&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;geo_point&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;pic&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
        <span class="nt">&#34;index&#34;</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">},</span>
      <span class="nt">&#34;all&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
        <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;text_anlyzer&#34;</span><span class="p">,</span>
        <span class="nt">&#34;search_analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;ik_smart&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;suggestion&#34;</span><span class="p">:{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;completion&#34;</span><span class="p">,</span>
          <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;completion_analyzer&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>



<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;match_all&#34;</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">GET</span> <span class="err">/hotel/_search</span>
<span class="p">{</span>
  <span class="nt">&#34;suggest&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;suggestions&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;text&#34;</span><span class="p">:</span><span class="s2">&#34;sd&#34;</span><span class="p">,</span>
      <span class="nt">&#34;completion&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;field&#34;</span><span class="p">:</span><span class="s2">&#34;suggestion&#34;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="err">GET</span> <span class="err">/hotel/_doc/</span><span class="mi">60223</span>





</code></pre></div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-02-13</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://example.org/posts/es%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/" data-title="ES从入门到入坟" data-hashtags="技术分享,ES"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://example.org/posts/es%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/" data-hashtag="技术分享"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="http://example.org/posts/es%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/" data-title="ES从入门到入坟"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="http://example.org/posts/es%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/" data-title="ES从入门到入坟"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://example.org/posts/es%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/" data-title="ES从入门到入坟"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a>,&nbsp;<a href="/tags/es/">ES</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83/" class="prev" rel="prev" title="认证与授权"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>认证与授权</a>
            <a href="/posts/%E7%AE%80%E8%B0%88%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8F%8A%E6%B8%B2%E6%9F%93/" class="next" rel="next" title="简谈浏览器工作及渲染">简谈浏览器工作及渲染<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.90.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2021 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
